<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI课件讲解 - 奕兆科技</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- ECharts for Mind Map -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <!-- Custom Select Component -->
    <link rel="stylesheet" href="components/custom-select.css">
    <script src="components/custom-select.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f3ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                        },
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }

        /* 自定义滚动条 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7d2fe;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a5b4fc;
        }

        /* 搜索框清空按钮 - 只在有内容且鼠标移入时显示 */
        #clearSearchBtn {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .search-input-wrapper:hover #clearSearchBtn.has-content {
            opacity: 1;
            pointer-events: auto;
        }

        /* Tab内容区自适应高度 */
        .tab-content-container {
            min-height: 0;
            flex: 1;
        }
        
        .tab-content {
            min-height: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        
        /* 确保视频和脑图容器自适应 */
        #mindmapContainer, #videoContainer {
            height: auto !important;
            min-height: 400px;
            flex: 1;
        }
        
        /* 思维导图容器自适应 */
        #mindmapContainer {
            flex: 1;
        }

        /* 课件卡片样式 */
        .course-card {
            transition: all 0.2s ease;
            position: relative;
        }

        /* 删除按钮样式 */
        .course-delete-btn {
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgb(239, 68, 68);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .course-delete-btn:hover {
            background: rgb(220, 38, 38);
            transform: translateY(-50%) scale(1.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 4px 16px rgba(220, 38, 38, 0.5);
        }

        .course-delete-btn svg {
            color: white !important;
            stroke: white !important;
            width: 14px;
            height: 14px;
            stroke-width: 2.5;
        }

        .course-card:hover .course-delete-btn {
            opacity: 1;
        }

        /* 生成讲解按钮样式 */
        .course-generate-btn {
            position: absolute;
            top: 50%;
            right: 50px;
            transform: translateY(-50%);
            padding: 6px 14px;
            border-radius: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            font-size: 13px;
            font-weight: 500;
            color: white;
        }

        .course-generate-btn:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f92 100%);
            transform: translateY(-50%) translateX(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .course-generate-btn svg {
            width: 14px;
            height: 14px;
        }

        .course-card:hover .course-generate-btn {
            opacity: 1;
        }


        /* 进度条动画 */
        @keyframes progress {
            0% { width: 0%; }
        }
        .progress-bar {
            animation: progress 0.5s ease-out;
        }

        /* 加载动画 */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 2s linear infinite;
        }

        /* 渐变背景动画 */
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .animate-gradient {
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
        }

        /* Tab切换动画 */
        .tab-content {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 思维导图节点样式 */
        .mindmap-node {
            transition: all 0.3s ease;
        }
        .mindmap-node:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        /* PPT播放器容器样式 */
        .ppt-player-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem; /* 四周留白 */
            box-sizing: border-box;
        }
        
        /* PPT图片样式 - 自适应容器，保持比例，显示最大 */
        .ppt-player-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        /* PPT导航按钮 - 左右两侧 - 扁平化风格 */
        .ppt-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 8px;
            padding: 20px 10px;
            cursor: pointer;
            opacity: 1;
            pointer-events: all;
            transition: all 0.2s ease, opacity 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .ppt-nav-btn:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-50%) translateX(0);
        }
        .ppt-nav-btn:active {
            transform: translateY(-50%) scale(0.95);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }
        .ppt-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.6);
        }
        .ppt-nav-btn:disabled:hover {
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .ppt-nav-btn i {
            color: #374151 !important;
            transition: color 0.2s ease;
        }
        .ppt-nav-btn:hover i {
            color: #111827 !important;
        }
        .ppt-nav-btn-left {
            left: 20px;
        }
        .ppt-nav-btn-right {
            right: 20px;
        }

        /* 思维导图全屏样式 */
        #mindmapWrapper:fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        #mindmapWrapper:-webkit-full-screen {
            width: 100vw !important;
            height: 100vh !important;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        #mindmapWrapper:-moz-full-screen {
            width: 100vw !important;
            height: 100vh !important;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        #mindmapWrapper:-ms-fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* 全屏时思维导图容器样式 */
        #mindmapWrapper:fullscreen #mindmapContainer,
        #mindmapWrapper:-webkit-full-screen #mindmapContainer,
        #mindmapWrapper:-moz-full-screen #mindmapContainer,
        #mindmapWrapper:-ms-fullscreen #mindmapContainer {
            width: 100% !important;
            height: 100% !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 0 !important;
            min-height: 100% !important;
        }

        /* 全屏时 ECharts 内部容器也使用 100% 高度 */
        #mindmapWrapper:fullscreen #mindmapContainer > div,
        #mindmapWrapper:-webkit-full-screen #mindmapContainer > div,
        #mindmapWrapper:-moz-full-screen #mindmapContainer > div,
        #mindmapWrapper:-ms-fullscreen #mindmapContainer > div {
            width: 100% !important;
            height: 100% !important;
        }

        /* 全屏时 ECharts canvas 也使用 100% 高度 */
        #mindmapWrapper:fullscreen #mindmapContainer canvas,
        #mindmapWrapper:-webkit-full-screen #mindmapContainer canvas,
        #mindmapWrapper:-moz-full-screen #mindmapContainer canvas,
        #mindmapWrapper:-ms-fullscreen #mindmapContainer canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* 在线课件选择弹窗 */
        .online-course-modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease;
        }
        .online-course-modal.active {
            display: flex;
        }
        .online-course-modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .online-course-modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .filter-section-fixed {
            padding: 16px 28px 12px 28px;
            background: white;
            border-bottom: 1px solid #f3f4f6;
        }
        .online-course-modal-body {
            padding: 12px 28px 24px 28px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }
        .filter-section {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .filter-select {
            flex: 1;
            min-width: 160px;
            padding: 8px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            height: 38px;
        }
        .filter-select:hover {
            border-color: #8b5cf6;
        }
        .filter-select:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        /* 自定义下拉组件样式 */
        .custom-select {
            position: relative;
            flex: 1;
            min-width: 160px;
            user-select: none;
        }
        .custom-select.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        .custom-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            height: 38px;
            position: relative;
        }
        .custom-select-trigger:hover {
            border-color: #8b5cf6;
        }
        .custom-select.open .custom-select-trigger {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        .custom-select-trigger .placeholder {
            color: #9ca3af;
        }
        .custom-select-trigger .selected-text {
            color: #374151;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .custom-select-icons {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
        }
        .custom-select-clear {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #e5e7eb;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .custom-select-clear:hover {
            background: #d1d5db;
        }
        .custom-select-trigger:hover .custom-select-clear.show {
            display: flex;
        }
        .custom-select-arrow {
            width: 14px;
            height: 14px;
            color: #6b7280;
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        .custom-select.open .custom-select-arrow {
            transform: rotate(180deg);
        }
        .custom-select-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-height: 280px;
            overflow-y: auto;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-8px);
            pointer-events: none;
            transition: all 0.2s;
        }
        .custom-select.open .custom-select-dropdown {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        .custom-select-option {
            padding: 10px 14px;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            transition: all 0.15s;
        }
        .custom-select-option:hover {
            background: #f3f4f6;
        }
        .custom-select-option.selected {
            background: #ede9fe;
            color: #7c3aed;
            font-weight: 500;
        }
        .custom-select-dropdown::-webkit-scrollbar {
            width: 6px;
        }
        .custom-select-dropdown::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-select-dropdown::-webkit-scrollbar-thumb {
            background: #c7d2fe;
            border-radius: 10px;
        }
        .custom-select-dropdown::-webkit-scrollbar-thumb:hover {
            background: #a5b4fc;
        }
        .search-input {
            width: 100%;
            padding: 8px 14px 8px 40px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s;
            height: 38px;
        }
        .search-input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        .search-wrapper {
            position: relative;
            flex: 0 0 280px;
            min-width: 200px;
        }
        .search-wrapper i, .search-wrapper .lucide {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        .course-list {
            display: grid;
            gap: 12px;
        }
        .course-item {
            padding: 16px 18px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            transition: all 0.2s;
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .course-item:hover {
            border-color: #8b5cf6;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
            transform: translateY(-1px);
        }
        .course-item-content {
            flex: 1;
            cursor: pointer;
        }
        .course-item-name {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 6px;
        }
        .course-item-meta {
            font-size: 11px;
            color: #b0b5bd;
            line-height: 1.4;
            font-weight: 400;
            letter-spacing: 0.2px;
        }
        .course-item-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .course-item:hover .course-item-actions {
            opacity: 1;
        }
        .course-item-actions .generate-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .course-item-actions .generate-btn:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a4190 100%);
            transform: translateX(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        .empty-state i {
            width: 64px;
            height: 64px;
            color: #d1d5db;
            margin-bottom: 16px;
        }
        .modal-actions {
            padding: 20px 28px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* 精致播放控制栏 - 悬浮底部 */
        .ppt-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            background: rgba(30, 41, 59, 0.65);
            backdrop-filter: blur(24px) saturate(150%);
            -webkit-backdrop-filter: blur(24px) saturate(150%);
            border-radius: 48px;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.25),
                0 2px 8px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.12) inset;
            opacity: 0;
            pointer-events: none;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .ppt-player-container:hover .ppt-controls {
            opacity: 1;
            pointer-events: all;
        }
        /* 鼠标静止时隐藏控制条 */
        .ppt-player-container.controls-hidden .ppt-controls {
            opacity: 0;
            pointer-events: none;
        }
        /* 全屏状态下鼠标静止时隐藏翻页按钮 */
        .ppt-player-container.controls-hidden .ppt-nav-btn {
            opacity: 0;
            pointer-events: none;
        }
        /* 全屏状态下隐藏鼠标光标 */
        .ppt-player-container.controls-hidden {
            cursor: none;
        }
        .ppt-controls button {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.92);
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .ppt-controls button::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.15), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .ppt-controls button:hover {
            background: rgba(255, 255, 255, 0.18);
            color: white;
            transform: scale(1.1);
        }
        .ppt-controls button:hover::before {
            opacity: 1;
        }
        .ppt-controls button:active {
            transform: scale(0.96);
        }
        .ppt-controls .divider {
            width: 1px;
            height: 22px;
            background: linear-gradient(to bottom, 
                transparent, 
                rgba(255, 255, 255, 0.22) 20%, 
                rgba(255, 255, 255, 0.22) 80%, 
                transparent);
            margin: 0 6px;
        }
        .ppt-controls .speed-btn {
            color: rgba(255, 255, 255, 0.95);
            font-size: 13px;
            font-weight: 500;
            padding: 7px 14px;
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.12);
            min-width: 55px;
            text-align: center;
            position: relative;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08) inset;
        }
        .ppt-controls .speed-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.1) inset,
                0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .ppt-controls .speed-btn:active {
            transform: translateY(0);
        }
        
        /* 倍速选择器容器 */
        .speed-selector {
            position: relative;
        }
        
        /* 倍速下拉菜单 */
        .speed-menu {
            position: absolute;
            bottom: calc(100% + 14px);
            left: 50%;
            transform: translateX(-50%) scale(0.96);
            background: rgba(30, 41, 59, 0.75);
            backdrop-filter: blur(24px) saturate(150%);
            -webkit-backdrop-filter: blur(24px) saturate(150%);
            border-radius: 18px;
            padding: 10px;
            min-width: 85px;
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.3),
                0 2px 12px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.12) inset;
            opacity: 0;
            pointer-events: none;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .speed-menu.show {
            opacity: 1;
            pointer-events: all;
            transform: translateX(-50%) translateY(-5px) scale(1);
        }
        
        .speed-menu-item {
            color: rgba(255, 255, 255, 0.92);
            font-size: 13px;
            font-weight: 500;
            padding: 10px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            background: transparent;
            width: 100%;
            border: none;
            display: block;
            position: relative;
        }
        
        .speed-menu-item:hover {
            background: rgba(255, 255, 255, 0.18);
            color: white;
            transform: translateX(2px);
        }
        
        .speed-menu-item.active {
            background: rgba(99, 102, 241, 0.28);
            color: #c7d2fe;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }
        
        .speed-menu-item.active::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            background: #c7d2fe;
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(199, 210, 254, 0.6);
        }
        
        /* 倍速菜单箭头 */
        .speed-menu::after {
            content: '';
            position: absolute;
            bottom: -7px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 13px;
            height: 13px;
            background: rgba(30, 41, 59, 0.75);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.15);
        }

        /* 音量控制器 */
        .volume-control {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .volume-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.2s ease;
        }
        
        .volume-btn:hover {
            color: #c7d2fe;
        }
        
        /* 音量滑块容器 */
        .volume-slider-container {
            position: absolute;
            bottom: calc(100% + 14px);
            left: 50%;
            transform: translateX(-50%) scale(0.96);
            background: rgba(30, 41, 59, 0.75);
            backdrop-filter: blur(24px) saturate(150%);
            -webkit-backdrop-filter: blur(24px) saturate(150%);
            border-radius: 18px;
            padding: 18px 12px;
            width: 52px;
            height: 145px;
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.3),
                0 2px 12px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.12) inset;
            opacity: 0;
            pointer-events: none;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .volume-slider-container.show {
            opacity: 1;
            pointer-events: all;
            transform: translateX(-50%) translateY(-5px) scale(1);
        }
        
        /* 音量滑块箭头 */
        .volume-slider-container::after {
            content: '';
            position: absolute;
            bottom: -7px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 13px;
            height: 13px;
            background: rgba(30, 41, 59, 0.75);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.15);
        }
        
        /* 竖向滑块样式 */
        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 115px;
            height: 7px;
            background: linear-gradient(to right, 
                rgba(255, 255, 255, 0.15), 
                rgba(255, 255, 255, 0.2));
            border-radius: 4px;
            outline: none;
            transform: rotate(-90deg);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12) inset;
        }
        
        /* 滑块轨道 - Webkit */
        .volume-slider::-webkit-slider-track {
            width: 100%;
            height: 7px;
            background: linear-gradient(to right, 
                rgba(255, 255, 255, 0.15), 
                rgba(255, 255, 255, 0.2));
            border-radius: 4px;
        }
        
        /* 滑块进度 - Webkit */
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 17px;
            height: 17px;
            background: linear-gradient(135deg, #818cf8 0%, #a78bfa 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 
                0 3px 10px rgba(129, 140, 248, 0.45),
                0 0 0 2px rgba(255, 255, 255, 0.15),
                0 0 18px rgba(129, 140, 248, 0.3);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 
                0 4px 14px rgba(129, 140, 248, 0.65),
                0 0 0 3px rgba(255, 255, 255, 0.2),
                0 0 25px rgba(129, 140, 248, 0.5);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* 滑块轨道 - Firefox */
        .volume-slider::-moz-range-track {
            width: 100%;
            height: 7px;
            background: linear-gradient(to right, 
                rgba(255, 255, 255, 0.15), 
                rgba(255, 255, 255, 0.2));
            border-radius: 4px;
        }
        
        /* 滑块进度 - Firefox */
        .volume-slider::-moz-range-thumb {
            width: 17px;
            height: 17px;
            background: linear-gradient(135deg, #818cf8 0%, #a78bfa 100%);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            box-shadow: 
                0 3px 10px rgba(129, 140, 248, 0.45),
                0 0 0 2px rgba(255, 255, 255, 0.1),
                0 0 18px rgba(129, 140, 248, 0.3);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .volume-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 
                0 4px 14px rgba(129, 140, 248, 0.65),
                0 0 0 3px rgba(255, 255, 255, 0.15),
                0 0 25px rgba(129, 140, 248, 0.5);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* PPT图片增强阴影 - 四周均匀 */
        .ppt-enhanced-shadow {
            box-shadow: 
                0 10px 25px -5px rgba(0, 0, 0, 0.15),
                0 -10px 25px -5px rgba(0, 0, 0, 0.12),
                0 0 15px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 顶部导航栏 -->
    <div class="h-full flex flex-col">
    <header class="bg-white border-b border-gray-200 z-50 shadow-sm flex-shrink-0">
        <div class="px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-gradient-to-br from-primary-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                </div>
                <span class="text-base font-semibold text-gray-800">奕兆科技</span>
            </div>
            <div class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 px-3 py-1.5 rounded-lg transition-colors">
                <div class="w-7 h-7 bg-gray-100 rounded-full flex items-center justify-center">
                    <i data-lucide="user" class="w-3.5 h-3.5 text-gray-600"></i>
                </div>
                <span class="text-sm text-gray-600 font-medium">Admin</span>
                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400"></i>
            </div>
        </div>
    </header>

    <!-- 返回按钮 -->
    <div class="fixed left-6 top-20 z-50">
        <button onclick="goBack()" class="w-11 h-11 bg-primary-500 hover:bg-primary-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all hover:-translate-x-1 flex items-center justify-center group">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
        </button>
    </div>

    <!-- 在线课件选择弹窗 -->
    <div id="onlineCourseModal" class="online-course-modal" onclick="closeOnlineCourseModalByBackdrop(event)">
        <div class="online-course-modal-content" onclick="event.stopPropagation()">
            <!-- 弹窗标题 -->
            <div class="online-course-modal-header">
                <div class="flex items-center gap-3">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">生成AI讲解</h2>
                        <p class="text-xs text-gray-500 mt-0.5">选择课件，一键生成个性化讲解</p>
                    </div>
                </div>
                <button onclick="closeOnlineCourseModal()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                </button>
            </div>

            <!-- 筛选区（固定不滚动） -->
            <div class="filter-section-fixed">
                <div class="filter-section">
                    <div id="subjectFilterContainer"></div>
                    <div id="gradeFilterContainer"></div>
                    <div id="versionFilterContainer"></div>
                    <div id="unitFilterContainer"></div>
                    <div class="search-wrapper">
                        <i data-lucide="search" class="w-4 h-4"></i>
                        <input type="text" id="onlineCourseSearchInput" class="search-input" placeholder="搜索课件名称..." oninput="handleOnlineCourseSearchInput()">
                    </div>
                </div>
            </div>

            <!-- 课件列表（可滚动） -->
            <div class="online-course-modal-body">
                <div id="onlineCourseList" class="course-list">
                    <!-- 课件列表将通过 JavaScript 动态生成 -->
                </div>
            </div>

        </div>
    </div>

    <!-- 主容器 -->
    <div class="flex-1 flex flex-col px-6 md:px-12 lg:px-16 xl:px-20 py-6 overflow-hidden">
        <div class="flex gap-6 flex-1 min-h-0">
            <!-- 左侧课件列表卡片 -->
            <aside class="w-72 flex-shrink-0 flex flex-col">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col flex-1">
                    <!-- 上传按钮组 -->
                    <div class="p-4 border-b border-gray-100 space-y-2">
                        <button onclick="handleLocalUpload()" class="w-full flex items-center justify-center gap-2 bg-white text-gray-700 border border-gray-300 px-4 py-2.5 rounded-lg hover:bg-gray-50 hover:border-primary-400 hover:text-primary-600 transition-colors font-medium text-sm">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            本地文件
                        </button>
                        <button onclick="handleOnlineCourse()" class="w-full flex items-center justify-center gap-2 bg-white text-gray-700 border border-gray-300 px-4 py-2.5 rounded-lg hover:bg-gray-50 hover:border-primary-400 hover:text-primary-600 transition-colors font-medium text-sm">
                            <i data-lucide="globe" class="w-4 h-4"></i>
                            在线课件
                        </button>
                    </div>

                    <!-- 搜索框 -->
                    <div class="px-4 pt-4">
                        <div class="relative search-input-wrapper">
                            <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                            <input type="text" id="courseSearchInput" placeholder="请输入关键词" class="w-full pl-9 pr-9 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-primary-400 focus:ring-1 focus:ring-primary-200 bg-gray-50" oninput="handleSearchInput()" onkeypress="if(event.key==='Enter'){window.searchTriggeredManually=true;clearTimeout(searchDebounceTimer);handleCourseSearch(this.value)}">
                            <button id="clearSearchBtn" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-gray-200 transition-colors" onclick="clearSearch()" title="清空">
                                <i data-lucide="x" class="w-4 h-4 text-gray-400"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 课件列表 -->
                    <div class="overflow-y-auto custom-scrollbar p-4 space-y-2 flex-1" id="courseList">
                        <div class="text-xs text-gray-500 font-medium mb-3">我的课件</div>
                        <!-- 课件项将动态生成 -->
                    </div>
                </div>
            </aside>

            <!-- 右侧内容卡片 -->
            <main class="flex-1 flex flex-col">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col flex-1">
                    <!-- 课件标题栏 -->
                    <div class="border-b border-gray-100 px-6 py-4">
                        <h2 class="text-lg font-bold text-gray-800" id="courseTitle">等腰三角形判定</h2>
                    </div>

                    <!-- Tab切换栏 -->
                    <div class="border-b border-gray-100 px-6">
                        <div class="flex gap-1">
                            <button class="tab-btn active px-4 py-3 text-sm font-medium relative rounded-t-lg" onclick="switchTab('explanation')" data-tab="explanation">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="book-open" class="w-4 h-4"></i>
                                    课件讲解
                                </div>
                                <div class="absolute bottom-0 left-0 right-0 h-0.5 bg-primary-500 tab-indicator"></div>
                            </button>
                            <button class="tab-btn px-4 py-3 text-sm font-medium relative text-gray-600 rounded-t-lg" onclick="switchTab('mindmap')" data-tab="mindmap">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="git-branch" class="w-4 h-4"></i>
                                    思维导图
                                </div>
                                <div class="absolute bottom-0 left-0 right-0 h-0.5 bg-primary-500 tab-indicator hidden"></div>
                            </button>
                            <button class="tab-btn px-4 py-3 text-sm font-medium relative text-gray-600 rounded-t-lg" onclick="switchTab('video')" data-tab="video">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="video" class="w-4 h-4"></i>
                                    视频概览
                                </div>
                                <div class="absolute bottom-0 left-0 right-0 h-0.5 bg-primary-500 tab-indicator hidden"></div>
                            </button>
                        </div>
                    </div>

                    <!-- Tab内容区 -->
                    <div class="tab-content-container flex-1 flex flex-col">
                        <!-- 课件讲解Tab -->
                        <div id="explanationTab" class="tab-content">
                            <!-- PPT播放器容器 -->
                            <div id="explanationContent" class="ppt-player-container">
                            <!-- 左侧导航按钮 -->
                            <button onclick="previousPage()" class="ppt-nav-btn ppt-nav-btn-left" id="prevBtn" title="上一页 (←)">
                                <i data-lucide="chevron-left" class="w-8 h-8 text-gray-700"></i>
                            </button>

                            <!-- PPT图片 -->
                            <img id="courseImage" src="data/img/0.png" alt="课件页面" class="w-auto ppt-enhanced-shadow rounded-lg border border-gray-200">

                            <!-- 右侧导航按钮 -->
                            <button onclick="nextPage()" class="ppt-nav-btn ppt-nav-btn-right" id="nextBtn" title="下一页 (→)">
                                <i data-lucide="chevron-right" class="w-8 h-8 text-gray-700"></i>
                                </button>
                                
                            <!-- 悬浮播放控制栏 -->
                            <div class="ppt-controls">
                                <!-- 播放/暂停 -->
                                <button onclick="togglePlay()" title="播放/暂停 (Space)">
                                    <i data-lucide="play" class="w-5 h-5" id="playIcon"></i>
                                </button>

                                <div class="divider"></div>

                                <!-- 倍速选择器 -->
                                <div class="speed-selector">
                                    <button class="speed-btn" onclick="toggleSpeedMenu()" title="播放速度">
                                        <span id="speedText">1.25x</span>
                                </button>

                                    <!-- 倍速下拉菜单 -->
                                    <div class="speed-menu" id="speedMenu">
                                        <button class="speed-menu-item" onclick="setSpeed(2.0)">2.0x</button>
                                        <button class="speed-menu-item" onclick="setSpeed(1.5)">1.5x</button>
                                        <button class="speed-menu-item active" onclick="setSpeed(1.25)">1.25x</button>
                                        <button class="speed-menu-item" onclick="setSpeed(1.0)">1.0x</button>
                                        <button class="speed-menu-item" onclick="setSpeed(0.75)">0.75x</button>
                                        <button class="speed-menu-item" onclick="setSpeed(0.5)">0.5x</button>
                                    </div>
                                </div>

                                <div class="divider"></div>

                                <!-- 音量控制器 -->
                                <div class="volume-control">
                                    <button class="volume-btn" onclick="toggleVolumeSlider()" title="音量">
                                        <i data-lucide="volume-2" class="w-5 h-5" id="volumeIcon"></i>
                                    </button>
                                    
                                    <!-- 音量滑块容器 -->
                                    <div class="volume-slider-container" id="volumeSliderContainer">
                                        <input type="range" 
                                               class="volume-slider" 
                                               id="volumeSlider" 
                                               min="0" 
                                               max="100" 
                                               value="100" 
                                               oninput="changeVolume(this.value)">
                                </div>
                            </div>

                                <div class="divider"></div>

                                <!-- 全屏 -->
                                <button onclick="toggleFullscreen()" title="全屏 (F)">
                                    <i data-lucide="maximize" class="w-5 h-5" id="fullscreenIcon"></i>
                                </button>
                        </div>
                    </div>

                    <!-- 未生成/失败状态 -->
                    <div id="explanationEmpty" class="hidden text-center py-20">
                        <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="book-open" class="w-8 h-8 text-primary-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2" id="explanationEmptyTitle">讲解未生成</h3>
                        <p class="text-sm text-gray-600 mb-4" id="explanationEmptyDesc">点击左侧上传或选择生成任务</p>
                        <button id="explanationRetryBtn" class="hidden inline-flex items-center gap-2 bg-primary-500 text-white px-5 py-2.5 rounded-lg hover:bg-primary-600 transition-colors font-medium">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            <span>重新生成讲解</span>
                        </button>
                    </div>
                        </div>

                        <!-- 思维导图Tab -->
                        <div id="mindmapTab" class="tab-content p-6 hidden">
                            <!-- 未生成状态 -->
                            <div id="mindmapEmpty" class="hidden text-center py-20">
                                <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i data-lucide="git-branch" class="w-8 h-8 text-primary-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800 mb-2" id="mindmapEmptyTitle">思维导图未生成</h3>
                                <p class="text-sm text-gray-600 mb-4" id="mindmapEmptyDesc">点击下方按钮，AI将为您生成课件知识结构图</p>
                                <button id="mindmapEmptyBtn" onclick="generateMindmap()" class="inline-flex items-center gap-2 bg-primary-500 text-white px-5 py-2.5 rounded-lg hover:bg-primary-600 transition-colors font-medium">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                                    <span>生成脑图</span>
                                </button>
                            </div>

                            <!-- 已生成状态 -->
                        <div id="mindmapContent">
                                <!-- 思维导图容器 -->
                                <div id="mindmapWrapper" style="position: relative;">
                                    <!-- 全屏按钮（右上角） -->
                                    <button onclick="toggleMindmapFullscreen()" class="flex items-center justify-center w-10 h-10 bg-white text-gray-700 rounded-lg shadow-lg hover:bg-gray-50 transition-colors border border-gray-200" style="position: absolute; top: 20px; right: 20px; z-index: 10;" title="全屏">
                                        <i id="mindmapFullscreenIcon" data-lucide="maximize" class="w-5 h-5"></i>
                                    </button>
                                    
                                    <div id="mindmapContainer" style="width: 100%; height: calc(100vh - 280px); min-height: 650px; border-radius: 12px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); box-shadow: inset 0 2px 8px rgba(0,0,0,0.03);"></div>
                                    
                                    <!-- 缩放控制按钮（右下角） -->
                                    <div style="position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 10;">
                                        <button onclick="zoomInMindmap()" class="flex items-center justify-center w-10 h-10 bg-white text-gray-700 rounded-lg shadow-lg hover:bg-gray-50 transition-colors border border-gray-200" title="放大">
                                            <i data-lucide="plus" class="w-5 h-5"></i>
                                        </button>
                                        <button onclick="zoomOutMindmap()" class="flex items-center justify-center w-10 h-10 bg-white text-gray-700 rounded-lg shadow-lg hover:bg-gray-50 transition-colors border border-gray-200" title="缩小">
                                            <i data-lucide="minus" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- 完成状态与讲解一致的展示 -->
                            <div id="mindmapMirror" class="hidden">
                                <div class="flex items-center justify-center mb-6">
                                    <img id="mindmapMirrorImage" src="data/img/0.png" alt="课件页面" class="max-w-full h-auto shadow-lg rounded-lg">
                                </div>
                            </div>
                        </div>

                        <!-- 视频概览Tab -->
                        <div id="videoTab" class="tab-content p-6 hidden">
                            <!-- 未生成状态 -->
                            <div id="videoEmpty" class="hidden text-center py-20">
                                <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i data-lucide="video" class="w-8 h-8 text-primary-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800 mb-2" id="videoEmptyTitle">视频概览未生成</h3>
                                <p class="text-sm text-gray-600 mb-4" id="videoEmptyDesc">点击下方按钮，AI将为您生成课件视频概览（约需2-3分钟）</p>
                                <button id="videoEmptyBtn" onclick="generateVideo()" class="inline-flex items-center gap-2 bg-primary-500 text-white px-5 py-2.5 rounded-lg hover:bg-primary-600 transition-colors font-medium">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                                    <span>生成视频</span>
                                </button>
                            </div>

                            <!-- 已生成状态 -->
                        <div id="videoContent" class="ppt-player-container" style="padding: 0;">
                                <!-- 视频播放器 -->
                                <video id="overviewVideo" class="w-auto ppt-enhanced-shadow rounded-lg border border-gray-200" style="max-width: 100%; max-height: 100%; object-fit: contain;" controls>
                                        <source src="data/final_presentation.mp4" type="video/mp4">
                                        您的浏览器不支持视频播放。
                                    </video>
                            </div>
                            <!-- 完成状态与讲解一致的展示 -->
                            <div id="videoMirror" class="hidden">
                                <div class="flex items-center justify-center mb-6">
                                    <img id="videoMirrorImage" src="data/img/0.png" alt="课件页面" class="max-w-full h-auto shadow-lg rounded-lg">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 上传进度弹窗 -->
    <div id="uploadModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 animate-gradient bg-gradient-to-br from-white to-primary-50">
            <div class="text-center">
                <div class="w-16 h-16 bg-gradient-to-br from-primary-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="upload" class="w-8 h-8 text-white"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">上传中</h3>
                <p class="text-gray-600 mb-6">正在上传课件文件...</p>
                
                <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden mb-2">
                    <div id="uploadProgress" class="h-full bg-gradient-to-r from-primary-500 to-purple-600 progress-bar" style="width: 0%"></div>
                </div>
                <div class="text-sm text-gray-600">
                    <span id="uploadPercent">0</span>%
                </div>
            </div>
        </div>
    </div>

    <!-- 生成讲解进度弹窗 -->
    <div id="generateModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-gradient-to-br from-primary-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="sparkles" class="w-8 h-8 text-white animate-pulse"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">AI生成中</h3>
                <p class="text-gray-600 mb-6" id="generateStage">正在解析课件内容...</p>
                
                <!-- 四阶段进度 -->
                <div class="space-y-3 mb-6">
                    <div class="flex items-center gap-3 text-sm">
                        <div class="w-6 h-6 rounded-full bg-primary-500 text-white flex items-center justify-center flex-shrink-0">
                            <i data-lucide="check" class="w-3 h-3" id="stage1Icon"></i>
                        </div>
                        <span class="text-gray-600">解析课件内容</span>
                    </div>
                    <div class="flex items-center gap-3 text-sm">
                        <div class="w-6 h-6 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center flex-shrink-0" id="stage2">
                            <span class="text-xs font-bold">2</span>
                        </div>
                        <span class="text-gray-400">分析知识点</span>
                    </div>
                    <div class="flex items-center gap-3 text-sm">
                        <div class="w-6 h-6 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center flex-shrink-0" id="stage3">
                            <span class="text-xs font-bold">3</span>
                        </div>
                        <span class="text-gray-400">生成讲解文案</span>
                    </div>
                    <div class="flex items-center gap-3 text-sm">
                        <div class="w-6 h-6 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center flex-shrink-0" id="stage4">
                            <span class="text-xs font-bold">4</span>
                        </div>
                        <span class="text-gray-400">语音合成</span>
                    </div>
                </div>
                
                <div class="text-sm text-gray-600">
                    正在生成第 <span id="generatePage">1</span> / 15 页
                </div>

                <button onclick="cancelGenerate()" class="mt-6 text-sm text-gray-500 hover:text-gray-700 transition-colors">
                    取消生成
                </button>
            </div>
        </div>
    </div>

    <!-- Toast提示 -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-xl shadow-2xl z-[100] opacity-0 transition-all duration-300 pointer-events-none flex items-center gap-3">
        <i id="toastIcon" data-lucide="check-circle" class="w-5 h-5"></i>
        <span id="toastMessage">操作成功</span>
    </div>

    <script>
        // 初始化 Lucide 图标
        lucide.createIcons();

        // 全局状态
        let appState = {
            currentCourse: null, // 使用 courses.json 的 id
            currentTab: 'explanation',
            currentPage: 1,
            totalPages: 15,
            isPlaying: false,
            currentTime: 0,
            duration: 225, // 3:45
            mindmapChart: null,
            narrationData: null, // 旁白数据
            speechSynthesis: window.speechSynthesis,
            currentUtterance: null, // 当前语音对象
            playbackRate: 1.25, // 播放速度
            volume: 1.0, // 音量
            courses: [], // 从 data/courses.json 加载
            searchKeyword: '',
            // 懒加载相关
            courseListPage: 1, // 当前加载页码
            courseListPageSize: 10, // 每页显示数量
            isLoadingMore: false, // 是否正在加载更多
            // 在线课件列表懒加载相关
            onlineCourseListPage: 1, // 在线课件当前加载页码
            onlineCourseListPageSize: 10, // 在线课件每页显示数量
            isLoadingMoreOnline: false, // 是否正在加载更多在线课件
            currentFilteredOnlineCourses: [] // 当前筛选后的在线课件列表
        };


        // Tab切换
        function switchTab(tabName) {
            // 更新Tab按钮样式
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-gray-600');
                btn.querySelector('.tab-indicator').classList.add('hidden');
            });
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.add('active');
            activeBtn.classList.remove('text-gray-600');
            activeBtn.querySelector('.tab-indicator').classList.remove('hidden');

            // 切换内容
            document.getElementById('explanationTab').classList.add('hidden');
            document.getElementById('mindmapTab').classList.add('hidden');
            document.getElementById('videoTab').classList.add('hidden');
            
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            appState.currentTab = tabName;

            // 根据当前课件状态显示内容或空状态
            const course = getCurrentCourse();
            
            if (tabName === 'mindmap') {
                const empty = document.getElementById('mindmapEmpty');
                const content = document.getElementById('mindmapContent');
                const mirror = document.getElementById('mindmapMirror');
                if (course && course.mindmapStatus === 'completed') {
                    empty.classList.add('hidden');
                    mirror.classList.add('hidden');
                    // 已完成状态：显示思维导图内容
                    content.classList.remove('hidden');
                    // 初始化思维导图
                    initMindmap();
                } else {
                    mirror.classList.add('hidden');
                    content.classList.add('hidden');
                    empty.classList.remove('hidden');
                    // 根据状态显示不同的提示
                    const title = document.getElementById('mindmapEmptyTitle');
                    const desc = document.getElementById('mindmapEmptyDesc');
                    const btn = document.getElementById('mindmapEmptyBtn');
                    const iconEl = btn.querySelector('i');
                    const textEl = btn.querySelector('span');
                    if (course.mindmapStatus === 'generating') {
                        title.textContent = '思维导图生成中';
                        desc.textContent = 'AI正在分析课件内容并构建知识结构...';
                        btn.style.display = 'none';
                    } else if (course.mindmapStatus === 'failed') {
                        title.textContent = '思维导图生成失败';
                        desc.textContent = '生成过程中出现错误，点击下方按钮可重新生成';
                        btn.style.display = 'inline-flex';
                        btn.onclick = () => generateMindmap();
                        iconEl.setAttribute('data-lucide', 'refresh-cw');
                        if (textEl) textEl.textContent = '重新生成脑图';
                        lucide.createIcons();
                    } else {
                        title.textContent = '思维导图未生成';
                        desc.textContent = '点击下方按钮，AI将为您生成课件知识结构图';
                        btn.style.display = 'inline-flex';
                        btn.onclick = () => generateMindmap();
                        iconEl.setAttribute('data-lucide', 'sparkles');
                        if (textEl) textEl.textContent = '生成脑图';
                        lucide.createIcons();
                    }
                }
            }
            
            if (tabName === 'video') {
                const empty = document.getElementById('videoEmpty');
                const content = document.getElementById('videoContent');
                const mirror = document.getElementById('videoMirror');
                if (course && course.videoStatus === 'completed') {
                    empty.classList.add('hidden');
                    mirror.classList.add('hidden');
                    // 已完成状态：显示视频内容
                    content.classList.remove('hidden');
                    // 所有课件的视频都显示同一个视频
                    const videoEl = document.getElementById('overviewVideo');
                    if (videoEl) {
                        videoEl.src = 'data/final_presentation.mp4'; // 统一的视频
                    }
                } else {
                    mirror.classList.add('hidden');
                    content.classList.add('hidden');
                    empty.classList.remove('hidden');
                    // 根据状态显示不同的提示
                    const title = document.getElementById('videoEmptyTitle');
                    const desc = document.getElementById('videoEmptyDesc');
                    const btn = document.getElementById('videoEmptyBtn');
                    const iconEl = btn.querySelector('i');
                    const textEl = btn.querySelector('span');
                    if (course.videoStatus === 'generating') {
                        title.textContent = '视频概览生成中';
                        desc.textContent = 'AI正在生成课件视频概览，请稍候...';
                        btn.style.display = 'none';
                    } else if (course.videoStatus === 'failed') {
                        title.textContent = '视频概览生成失败';
                        desc.textContent = '生成过程中出现错误，点击下方按钮可重新生成（约需2-3分钟）';
                        btn.style.display = 'inline-flex';
                        btn.onclick = () => generateVideo();
                        iconEl.setAttribute('data-lucide', 'refresh-cw');
                        if (textEl) textEl.textContent = '重新生成视频';
                        lucide.createIcons();
                    } else {
                        title.textContent = '视频概览未生成';
                        desc.textContent = '点击下方按钮，AI将为您生成课件视频概览（约需2-3分钟）';
                        btn.style.display = 'inline-flex';
                        btn.onclick = () => generateVideo();
                        iconEl.setAttribute('data-lucide', 'sparkles');
                        if (textEl) textEl.textContent = '生成视频';
                        lucide.createIcons();
                    }
                }
            }

            lucide.createIcons();
        }

        // 渲染课件列表（支持懒加载）
        function renderCourseList(append = false) {
            const courseList = document.getElementById('courseList');
            
            if (!append) {
                // 首次加载，清空列表并重置分页
            courseList.innerHTML = '<div class="text-xs text-gray-500 font-medium mb-3">我的课件</div>';
                appState.courseListPage = 1;
            }
            
            // 课件类型配置
            const typeConfig = {
                online: { icon: 'globe', bgColor: 'bg-blue-500', tagColor: 'bg-blue-100 text-blue-700', label: '在线' },
                pdf: { icon: 'file-text', bgColor: 'bg-red-500', tagColor: 'bg-red-100 text-red-700', label: 'PDF' },
                ppt: { icon: 'presentation', bgColor: 'bg-orange-500', tagColor: 'bg-orange-100 text-orange-700', label: 'PPT' }
            };
            
            // 过滤与排序
            const filtered = appState.courses
                .filter(c => !appState.searchKeyword || c.name.includes(appState.searchKeyword))
                .sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime));

            // 计算当前页的课件
            const startIndex = (appState.courseListPage - 1) * appState.courseListPageSize;
            const endIndex = startIndex + appState.courseListPageSize;
            const currentPageCourses = filtered.slice(startIndex, endIndex);
            
            // 渲染当前页的课件
            currentPageCourses.forEach((course) => {
                const config = typeConfig[course.type];
                const isActive = course.id === appState.currentCourse;
                
                const courseCard = document.createElement('div');
                courseCard.className = `course-card p-3 rounded-lg transition-all cursor-pointer ${
                    isActive 
                        ? 'border-2 border-primary-500 bg-primary-50'
                        : 'hover:bg-gray-50'
                }`;
                
                courseCard.onclick = () => selectCourse(course.id);
                
                courseCard.innerHTML = `
                    <button class="course-delete-btn" onclick="event.stopPropagation(); deleteCourse('${course.id}')" title="删除课件">
                        <i data-lucide="x" style="color: white; stroke: white;"></i>
                    </button>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 ${config.bgColor} rounded-lg flex items-center justify-center flex-shrink-0">
                            <i data-lucide="${config.icon}" class="w-5 h-5 text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-sm text-gray-900 truncate">${course.name}</div>
                        </div>
                        <div class="text-xs text-gray-500 font-medium flex-shrink-0">${course.pages}页</div>
                    </div>
                `;
                
                courseList.appendChild(courseCard);
            });
            
            // 移除旧的加载指示器（如果有）
            const oldLoader = document.getElementById('courseListLoader');
            if (oldLoader) oldLoader.remove();
            
            // 如果还有更多课件，显示加载指示器
            if (endIndex < filtered.length) {
                const loader = document.createElement('div');
                loader.id = 'courseListLoader';
                loader.className = 'text-center py-3 text-xs text-gray-400';
                loader.innerHTML = '<i data-lucide="loader" class="w-4 h-4 inline-block animate-spin"></i> 加载中...';
                courseList.appendChild(loader);
            }
            
            lucide.createIcons();
            appState.isLoadingMore = false;
            // 若列表未出现滚动条且还有更多项，自动继续加载，避免停留在“加载中...”
            setTimeout(autoFillCourseListIfNeeded, 0);
        }

        // 选择课件
        function selectCourse(courseId) {
            const course = appState.courses.find(c => c.id === courseId);
            if (!course) return;

            appState.currentCourse = courseId;

            // 更新标题
            document.getElementById('courseTitle').textContent = course.name;
            
            // 重新渲染课件列表以更新选中状态
            renderCourseList();

            // 重置页面
            appState.currentPage = 1;
            appState.totalPages = course.pages;
            updateCoursePage();
            
            // 重置思维导图
            appState.mindmapChart = null;

            // 切换回课件讲解Tab
            switchTab('explanation');
        }

        // 自定义确认对话框
        function showConfirmDialog(title, message, confirmText = '确定') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmDialog');
                const dialog = document.getElementById('confirmDialogInner');
                const titleEl = document.getElementById('confirmDialogTitle');
                const messageEl = document.getElementById('confirmDialogMessage');
                const cancelBtn = document.getElementById('confirmDialogCancel');
                const confirmBtn = document.getElementById('confirmDialogConfirm');

                // 设置内容
                titleEl.textContent = title;
                messageEl.textContent = message;
                confirmBtn.textContent = confirmText;

                // 显示对话框
                modal.classList.remove('hidden');
                setTimeout(() => {
                    dialog.classList.remove('scale-95', 'opacity-0');
                    dialog.classList.add('scale-100', 'opacity-100');
                }, 10);

                lucide.createIcons();

                // 处理确认
                const handleConfirm = () => {
                    dialog.classList.add('scale-95', 'opacity-0');
                    dialog.classList.remove('scale-100', 'opacity-100');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        cleanup();
                        resolve(true);
                    }, 200);
                };

                // 处理取消
                const handleCancel = () => {
                    dialog.classList.add('scale-95', 'opacity-0');
                    dialog.classList.remove('scale-100', 'opacity-100');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        cleanup();
                        resolve(false);
                    }, 200);
                };

                // 清理事件监听器
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    modal.removeEventListener('click', handleBackdropClick);
                };

                // 点击背景关闭
                const handleBackdropClick = (e) => {
                    if (e.target === modal) {
                        handleCancel();
                    }
                };

                // 绑定事件
                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
                modal.addEventListener('click', handleBackdropClick);
            });
        }

        // 删除课件
        async function deleteCourse(courseId) {
            const course = appState.courses.find(c => c.id === courseId);
            if (!course) return;

            // 显示自定义确认对话框
            const confirmed = await showConfirmDialog(
                '删除课件讲解',
                `确定要删除「${course.name}」的讲解吗？\n删除后将无法恢复。`,
                '删除讲解'
            );

            if (!confirmed) return;

            // 从课件列表中删除
            const courseIndex = appState.courses.findIndex(c => c.id === courseId);
            if (courseIndex !== -1) {
                appState.courses.splice(courseIndex, 1);
            }

            // 如果删除的是当前选中的课件
            if (appState.currentCourse === courseId) {
                // 尝试选中下一个课件，如果没有则选中上一个，如果都没有则清空
                if (appState.courses.length > 0) {
                    const nextCourse = appState.courses[Math.min(courseIndex, appState.courses.length - 1)];
                    selectCourse(nextCourse.id);
                } else {
                    // 没有课件了，清空当前选择
                    appState.currentCourse = null;
                    document.getElementById('courseTitle').textContent = '请选择课件';
                    renderCourseList();
                }
            } else {
                // 只需要刷新列表
                renderCourseList();
            }

            showToast(`已删除课件讲解：${course.name}`, 'success');
        }

        // 更新课件页面
        function updateCoursePage() {
            const course = getCurrentCourse();
            const explanationCompleted = course && course.explanationStatus === 'completed';
            const explanationEmpty = document.getElementById('explanationEmpty');
            const explanationContent = document.getElementById('explanationContent');

            if (!course) return;

            // 右侧讲解区显示：完成显示内容；否则显示空状态或失败提示
            if (explanationCompleted) {
                explanationEmpty.classList.add('hidden');
                explanationContent.classList.remove('hidden');
                // 所有课件的讲解都显示同一份内容
                const explanationText = document.getElementById('explanationText');
                if (explanationText) {
                    // 加载统一的讲解内容
                    fetch('data/narration.json')
                        .then(response => response.json())
                        .then(data => {
                            explanationText.innerHTML = data.content || '讲解内容加载中...';
                        })
                        .catch(() => {
                            explanationText.innerHTML = '讲解内容加载失败';
                        });
                }
            } else {
                explanationContent.classList.add('hidden');
                explanationEmpty.classList.remove('hidden');
                const title = document.getElementById('explanationEmptyTitle');
                const desc = document.getElementById('explanationEmptyDesc');
                const retryBtn = document.getElementById('explanationRetryBtn');
                if (course.explanationStatus === 'generating') {
                    title.textContent = '讲解生成中';
                    desc.textContent = '系统正在生成讲解，请稍候...';
                    retryBtn.classList.add('hidden');
                } else if (course.explanationStatus === 'failed') {
                    title.textContent = '讲解生成失败';
                    desc.textContent = '生成过程中出现错误，点击下方按钮可重新生成';
                    retryBtn.classList.remove('hidden');
                    retryBtn.onclick = () => regenerateExplanation();
                    const retryBtnIcon = retryBtn.querySelector('i');
                    const retryBtnText = retryBtn.querySelector('span');
                    if (retryBtnIcon) retryBtnIcon.setAttribute('data-lucide', 'sparkles');
                    if (retryBtnText) retryBtnText.textContent = '生成讲解';
                    lucide.createIcons();
                } else {
                    title.textContent = '讲解未生成';
                    desc.textContent = '点击左侧上传或选择生成任务';
                    retryBtn.classList.add('hidden');
                }
            }

            // 图片统一共用同一份内容数据（所有课件都使用相同的内容）
            const imgPath = `data/img/${Math.max(0, appState.currentPage - 1)}.png`;
            const courseImage = document.getElementById('courseImage');
            if (courseImage) courseImage.src = imgPath;

            const currentPageEl = document.getElementById('currentPage');
            const totalPagesEl = document.getElementById('totalPages');
            if (currentPageEl) currentPageEl.textContent = appState.currentPage;
            if (totalPagesEl) totalPagesEl.textContent = appState.totalPages;

            // 更新按钮状态
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            if (prevBtn) prevBtn.disabled = appState.currentPage <= 1;
            if (nextBtn) nextBtn.disabled = appState.currentPage >= appState.totalPages;
        }

        // 切换缩略图导航
        function toggleThumbnails() {
            const thumbnailNav = document.getElementById('thumbnailNav');
            const thumbnailGrid = document.getElementById('thumbnailGrid');
            
            if (thumbnailNav.classList.contains('hidden')) {
                thumbnailNav.classList.remove('hidden');
                
                // 生成缩略图（所有课件共用同一份图片数据）
                if (thumbnailGrid.children.length === 0) {
                    for (let i = 0; i < appState.totalPages; i++) {
                        const thumb = document.createElement('div');
                        thumb.className = 'cursor-pointer border-2 border-gray-200 rounded-lg overflow-hidden hover:border-primary-500 transition-colors';
                        thumb.innerHTML = `
                            <img src="data/img/${i}.png" alt="第${i+1}页" class="w-full h-auto">
                            <div class="text-xs text-center py-1 bg-gray-50">第${i+1}页</div>
                        `;
                        thumb.onclick = () => jumpToPage(i + 1);
                        thumbnailGrid.appendChild(thumb);
                    }
                }
            } else {
                thumbnailNav.classList.add('hidden');
            }
            
            lucide.createIcons();
        }

        // 跳转到指定页面
        function jumpToPage(page) {
            // 停止当前播放
            if (appState.isPlaying) {
                appState.isPlaying = false;
                stopSpeech();
                const playIcon = document.getElementById('playIcon');
                playIcon.setAttribute('data-lucide', 'play');
                lucide.createIcons();
            }
            
            appState.currentPage = page;
            updateCoursePage();
            appState.currentTime = 0;
            updateAudioProgress();
            
            // 关闭缩略图导航
            document.getElementById('thumbnailNav').classList.add('hidden');
        }

        // 播放/暂停
        function togglePlay() {
            appState.isPlaying = !appState.isPlaying;
            const playIcon = document.getElementById('playIcon');
            
            if (appState.isPlaying) {
                playIcon.setAttribute('data-lucide', 'pause');
                startSpeech();
            } else {
                playIcon.setAttribute('data-lucide', 'play');
                stopSpeech();
            }
            
            lucide.createIcons();
        }

        // 开始语音播放
        let progressInterval;
        function startSpeech() {
            // 检查是否有旁白数据
            if (!appState.narrationData || !appState.narrationData.pages) {
                showToast('旁白数据未加载', 'error');
                appState.isPlaying = false;
                return;
            }

            // 检查浏览器是否支持 Web Speech API
            if (!appState.speechSynthesis) {
                showToast('您的浏览器不支持语音合成', 'error');
                appState.isPlaying = false;
                return;
            }

            // 停止之前的播放
            if (appState.currentUtterance) {
                appState.speechSynthesis.cancel();
            }

            // 获取当前页面的旁白
            const currentPageData = appState.narrationData.pages.find(p => p.page === appState.currentPage);
            if (!currentPageData || !currentPageData.narration) {
                showToast('当前页面没有旁白', 'error');
                appState.isPlaying = false;
                return;
            }

            // 创建语音对象
            const utterance = new SpeechSynthesisUtterance(currentPageData.narration);
            appState.currentUtterance = utterance;

            // 设置语音参数
            utterance.lang = 'zh-CN'; // 中文
            utterance.rate = appState.playbackRate || 1.0; // 语速
            utterance.pitch = 1.0; // 音调
            utterance.volume = appState.volume || 1.0; // 音量

            // 估算总时长（基于文本长度，平均每秒5个字）
            const textLength = currentPageData.narration.length;
            appState.duration = Math.ceil(textLength / 5);
            appState.currentTime = 0;

            // 语音结束时的回调
            utterance.onend = () => {
                appState.isPlaying = false;
                const playIcon = document.getElementById('playIcon');
                playIcon.setAttribute('data-lucide', 'play');
                lucide.createIcons();
                
                // 自动翻到下一页
                if (appState.currentPage < appState.totalPages) {
                    nextPage();
                } else {
                    // 最后一页播放完，重置进度
                    appState.currentTime = 0;
                    updateAudioProgress();
                }
            };

            // 语音错误时的回调
            utterance.onerror = (event) => {
                console.error('语音播放错误:', event);
                showToast('语音播放出错', 'error');
                appState.isPlaying = false;
                const playIcon = document.getElementById('playIcon');
                playIcon.setAttribute('data-lucide', 'play');
                lucide.createIcons();
            };

            // 开始播放
            appState.speechSynthesis.speak(utterance);

            // 开始进度条更新
            progressInterval = setInterval(() => {
                if (appState.isPlaying) {
                    appState.currentTime += 1;
                    if (appState.currentTime > appState.duration) {
                        appState.currentTime = appState.duration;
                    }
                    updateAudioProgress();
                }
            }, 1000);
        }

        // 停止语音播放
        function stopSpeech() {
            if (appState.speechSynthesis) {
                appState.speechSynthesis.cancel();
            }
            if (progressInterval) {
                clearInterval(progressInterval);
            }
        }

        // 倍速相关功能
        let currentSpeed = 1.25; // 默认1.25x
        
        // 切换倍速菜单显示/隐藏
        function toggleSpeedMenu() {
            const menu = document.getElementById('speedMenu');
            menu.classList.toggle('show');
        }
        
        // 设置播放速度
        function setSpeed(speed) {
            currentSpeed = speed;
            appState.playbackRate = speed;
            
            // 更新显示文本
            document.getElementById('speedText').textContent = speed + 'x';
            
            // 更新菜单项的active状态
            const menuItems = document.querySelectorAll('.speed-menu-item');
            menuItems.forEach(item => {
                const itemSpeed = parseFloat(item.textContent);
                if (itemSpeed === speed) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // 如果正在播放,更新当前语音速度
            if (appState.currentUtterance) {
                appState.currentUtterance.rate = speed;
            }
            
            // 关闭菜单
            document.getElementById('speedMenu').classList.remove('show');
        }
        
        // 点击其他地方关闭倍速菜单
        document.addEventListener('click', function(event) {
            const speedSelector = document.querySelector('.speed-selector');
            const speedMenu = document.getElementById('speedMenu');
            
            if (speedSelector && !speedSelector.contains(event.target)) {
                speedMenu.classList.remove('show');
            }
        });

        // 音量控制功能
        let currentVolume = 100; // 默认100%音量
        
        // 切换音量滑块显示/隐藏
        function toggleVolumeSlider() {
            const container = document.getElementById('volumeSliderContainer');
            container.classList.toggle('show');
        }
        
        // 改变音量
        function changeVolume(value) {
            currentVolume = parseInt(value);
            const volumePercent = currentVolume / 100;
            appState.volume = volumePercent;
            
            // 更新音量图标
            updateVolumeIcon(currentVolume);
            
            // 如果正在播放，更新当前语音音量
            if (appState.currentUtterance) {
                appState.currentUtterance.volume = volumePercent;
            }
        }
        
        // 更新音量图标
        function updateVolumeIcon(volume) {
            const volumeIcon = document.getElementById('volumeIcon');
            
            if (volume === 0) {
                volumeIcon.setAttribute('data-lucide', 'volume-x');
            } else if (volume < 50) {
                volumeIcon.setAttribute('data-lucide', 'volume-1');
            } else {
                volumeIcon.setAttribute('data-lucide', 'volume-2');
            }
            
            lucide.createIcons();
        }
        
        // 点击其他地方关闭音量滑块
        document.addEventListener('click', function(event) {
            const volumeControl = document.querySelector('.volume-control');
            const volumeContainer = document.getElementById('volumeSliderContainer');
            
            if (volumeControl && !volumeControl.contains(event.target)) {
                volumeContainer.classList.remove('show');
            }
        });

        // PPT播放器鼠标静止3秒后自动隐藏控制条
        let mouseIdleTimer = null;
        const pptContainer = document.querySelector('.ppt-player-container');
        
        if (pptContainer) {
            // 鼠标移动时
            pptContainer.addEventListener('mousemove', function() {
                // 移除隐藏类，显示控制条
                pptContainer.classList.remove('controls-hidden');
                
                // 清除之前的定时器
                if (mouseIdleTimer) {
                    clearTimeout(mouseIdleTimer);
                }
                
                // 设置新的定时器，3秒后隐藏控制条
                mouseIdleTimer = setTimeout(function() {
                    pptContainer.classList.add('controls-hidden');
                }, 3000);
            });
            
            // 鼠标离开容器时清除定时器，让CSS的hover规则接管
            pptContainer.addEventListener('mouseleave', function() {
                if (mouseIdleTimer) {
                    clearTimeout(mouseIdleTimer);
                    mouseIdleTimer = null;
                }
                pptContainer.classList.remove('controls-hidden');
            });
            
            // 鼠标进入容器时启动定时器
            pptContainer.addEventListener('mouseenter', function() {
                pptContainer.classList.remove('controls-hidden');
                mouseIdleTimer = setTimeout(function() {
                    pptContainer.classList.add('controls-hidden');
                }, 3000);
            });
        }

        // 切换全屏
        function toggleFullscreen() {
            const container = document.querySelector('.ppt-player-container');
            const fullscreenIcon = document.getElementById('fullscreenIcon');
            
            if (!document.fullscreenElement) {
                if (container.requestFullscreen) {
                    container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) { // Safari
                    container.webkitRequestFullscreen();
                } else if (container.msRequestFullscreen) { // IE11
                    container.msRequestFullscreen();
                }
                fullscreenIcon.setAttribute('data-lucide', 'minimize');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) { // Safari
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE11
                    document.msExitFullscreen();
                }
                fullscreenIcon.setAttribute('data-lucide', 'maximize');
            }
            
            lucide.createIcons();
        }

        // 监听全屏状态变化
        document.addEventListener('fullscreenchange', () => {
            const fullscreenIcon = document.getElementById('fullscreenIcon');
            if (document.fullscreenElement) {
                fullscreenIcon.setAttribute('data-lucide', 'minimize');
            } else {
                fullscreenIcon.setAttribute('data-lucide', 'maximize');
            }
            lucide.createIcons();
        });

        function updateAudioProgress() {
            const progress = (appState.currentTime / appState.duration) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            const minutes = Math.floor(appState.currentTime / 60);
            const seconds = appState.currentTime % 60;
            document.getElementById('currentTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // 拖动进度条
        function seekAudio(event) {
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percentage = x / rect.width;
            appState.currentTime = Math.floor(percentage * appState.duration);
            updateAudioProgress();
        }

        // 音量控制
        function setVolume(value) {
            appState.volume = value;
            
            // 如果正在播放，更新当前语音的音量
            if (appState.currentUtterance && appState.isPlaying) {
                // Web Speech API 不支持动态修改音量，需要重新播放
                const wasPlaying = appState.isPlaying;
                if (wasPlaying) {
                    stopSpeech();
                    appState.isPlaying = false;
                    
                    // 短暂延迟后重新开始
                    setTimeout(() => {
                        appState.isPlaying = true;
                        startSpeech();
                    }, 100);
                }
            }
        }

        // 播放速度
        function setPlaybackRate(rate) {
            // 如果正在播放，重新开始播放以应用新速度
            const wasPlaying = appState.isPlaying;
            if (wasPlaying) {
                stopSpeech();
                appState.isPlaying = false;
            }
            
            // 保存播放速度
            appState.playbackRate = rate;
            
            // 如果之前在播放，重新开始
            if (wasPlaying) {
                appState.isPlaying = true;
                startSpeech();
            }
        }

        // 上一页
        function previousPage() {
            if (appState.currentPage > 1) {
                // 停止当前播放
                if (appState.isPlaying) {
                    appState.isPlaying = false;
                    stopSpeech();
                    const playIcon = document.getElementById('playIcon');
                    playIcon.setAttribute('data-lucide', 'play');
                    lucide.createIcons();
                }
                
                appState.currentPage--;
                updateCoursePage();
                appState.currentTime = 0;
                updateAudioProgress();
            }
        }

        // 下一页
        function nextPage() {
            if (appState.currentPage < appState.totalPages) {
                // 停止当前播放
                if (appState.isPlaying) {
                    appState.isPlaying = false;
                    stopSpeech();
                    const playIcon = document.getElementById('playIcon');
                    playIcon.setAttribute('data-lucide', 'play');
                    lucide.createIcons();
                }
                
                appState.currentPage++;
                updateCoursePage();
                appState.currentTime = 0;
                updateAudioProgress();
            }
        }

        // 初始化思维导图
        async function initMindmap() {
            try {
                const response = await fetch('data/swdt.json');
                const data = await response.json();
                
                const container = document.getElementById('mindmapContainer');
                appState.mindmapChart = echarts.init(container);
                
                // 转换数据格式
                const treeData = {
                    name: data.title,
                    children: data.nodes.map(node => convertNode(node))
                };
                
                const option = {
                    tooltip: {
                        trigger: 'item',
                        triggerOn: 'mousemove',
                        backgroundColor: 'rgba(50, 50, 50, 0.9)',
                        borderColor: '#6366f1',
                        borderWidth: 1,
                        textStyle: {
                            color: '#fff',
                            fontSize: 13
                        },
                        formatter: '{b}'
                    },
                    toolbox: {
                        show: false  // 隐藏工具栏按钮
                    },
                    series: [{
                        type: 'tree',
                        data: [treeData],
                        top: '8%',
                        left: '5%',
                        bottom: '8%',
                        right: '5%',
                        layout: 'orthogonal',
                        symbolSize: 12,
                        orient: 'LR',
                        roam: true,
                        label: {
                            position: 'left',
                            verticalAlign: 'middle',
                            align: 'right',
                            fontSize: 14,
                            fontWeight: 500,
                            backgroundColor: '#ffffff',
                            borderColor: '#6366f1',
                            borderWidth: 2,
                            borderRadius: 6,
                            padding: [6, 10],
                            color: '#1f2937',
                            shadowColor: 'rgba(0, 0, 0, 0.1)',
                            shadowBlur: 6,
                            shadowOffsetX: 2,
                            shadowOffsetY: 2
                        },
                        leaves: {
                            label: {
                                position: 'right',
                                verticalAlign: 'middle',
                                align: 'left',
                                fontSize: 13,
                                fontWeight: 400,
                                backgroundColor: '#f9fafb',
                                borderColor: '#9ca3af',
                                borderWidth: 1.5,
                                borderRadius: 6,
                                padding: [5, 10],
                                color: '#374151',
                                shadowColor: 'rgba(0, 0, 0, 0.08)',
                                shadowBlur: 4,
                                shadowOffsetX: 1,
                                shadowOffsetY: 1
                            }
                        },
                        expandAndCollapse: true,
                        initialTreeDepth: 3,
                        animationDuration: 600,
                        animationDurationUpdate: 800,
                        animationEasing: 'cubicOut',
                        itemStyle: {
                            color: '#6366f1',
                            borderColor: '#fff',
                            borderWidth: 3,
                            shadowColor: 'rgba(99, 102, 241, 0.3)',
                            shadowBlur: 8
                        },
                        lineStyle: {
                            color: '#a5b4fc',
                            width: 2,
                            type: 'polyline',
                            shadowColor: 'rgba(165, 180, 252, 0.3)',
                            shadowBlur: 4,
                            shadowOffsetY: 2
                        },
                        emphasis: {
                            focus: 'descendant',
                            itemStyle: {
                                color: '#4f46e5',
                                borderColor: '#fff',
                                borderWidth: 4,
                                shadowColor: 'rgba(79, 70, 229, 0.5)',
                                shadowBlur: 15
                            },
                            lineStyle: {
                                width: 3.5,
                                color: '#6366f1'
                            },
                            label: {
                                fontWeight: 600,
                                color: '#111827',
                                backgroundColor: '#eef2ff',
                                borderColor: '#4f46e5',
                                borderWidth: 2.5,
                                shadowBlur: 10,
                                shadowColor: 'rgba(79, 70, 229, 0.3)'
                            }
                        }
                    }]
                };
                
                appState.mindmapChart.setOption(option);
                
                // 等待图表渲染完成后自动调整缩放以适应所有内容
                setTimeout(() => {
                    if (appState.mindmapChart) {
                        // 自动计算合适的缩放比例
                        const containerWidth = container.offsetWidth;
                        const containerHeight = container.offsetHeight;
                        
                        // 获取树的实际边界
                        // 由于 ECharts tree 布局，我们需要设置一个合适的初始缩放
                        // 让内容能够完整显示在视口中
                        const initialZoom = 0.6; // 设置一个较小的初始缩放，确保内容不会被遮挡
                        
                        appState.mindmapChart.setOption({
                            series: [{
                                zoom: initialZoom,
                                center: ['30%', '50%'] // 将中心点稍微向左移动，因为是从左到右布局
                            }]
                        });
                    }
                }, 100);
            } catch (error) {
                console.error('加载思维导图失败:', error);
            }
        }

        function convertNode(node) {
            const result = {
                name: node.text
            };
            if (node.children && node.children.length > 0) {
                result.children = node.children.map(child => convertNode(child));
            }
            return result;
        }

        // 展开全部
        function expandAll() {
            if (appState.mindmapChart) {
                const option = appState.mindmapChart.getOption();
                option.series[0].initialTreeDepth = -1;
                appState.mindmapChart.setOption(option);
                showToast('已展开全部节点', 'success');
            }
        }

        // 收起全部
        function collapseAll() {
            if (appState.mindmapChart) {
                const option = appState.mindmapChart.getOption();
                option.series[0].initialTreeDepth = 2;
                appState.mindmapChart.setOption(option);
                showToast('已收起节点', 'success');
            }
        }

        // 放大思维导图
        function zoomInMindmap() {
            if (appState.mindmapChart) {
                appState.mindmapChart.dispatchAction({
                    type: 'takeGlobalCursor',
                    key: 'dataZoomSelect',
                    dataZoomSelectActive: true
                });
                
                // 通过缩放比例放大
                const zoom = appState.mindmapChart.getOption().series[0].zoom || 1;
                const newZoom = Math.min(zoom * 1.2, 3); // 最大放大到3倍
                
                appState.mindmapChart.setOption({
                    series: [{
                        zoom: newZoom
                    }]
                });
            }
        }

        // 缩小思维导图
        function zoomOutMindmap() {
            if (appState.mindmapChart) {
                const zoom = appState.mindmapChart.getOption().series[0].zoom || 1;
                const newZoom = Math.max(zoom * 0.8, 0.3); // 最小缩小到0.3倍
                
                appState.mindmapChart.setOption({
                    series: [{
                        zoom: newZoom
                    }]
                });
            }
        }

        // 重置思维导图缩放
        function resetZoomMindmap() {
            if (appState.mindmapChart) {
                appState.mindmapChart.setOption({
                    series: [{
                        zoom: 1,
                        center: null
                    }]
                });
                showToast('已重置视图', 'success');
            }
        }

        // 切换思维导图全屏
        function toggleMindmapFullscreen() {
            const wrapper = document.getElementById('mindmapWrapper');
            const fullscreenIcon = document.getElementById('mindmapFullscreenIcon');
            
            if (!document.fullscreenElement) {
                // 进入全屏
                if (wrapper.requestFullscreen) {
                    wrapper.requestFullscreen();
                } else if (wrapper.webkitRequestFullscreen) { // Safari
                    wrapper.webkitRequestFullscreen();
                } else if (wrapper.msRequestFullscreen) { // IE11
                    wrapper.msRequestFullscreen();
                }
                fullscreenIcon.setAttribute('data-lucide', 'minimize');
            } else {
                // 退出全屏
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) { // Safari
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE11
                    document.msExitFullscreen();
                }
                fullscreenIcon.setAttribute('data-lucide', 'maximize');
            }
            
            lucide.createIcons();
        }
        
        // 监听全屏变化事件
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('msfullscreenchange', handleFullscreenChange);
        
        function handleFullscreenChange() {
            const container = document.getElementById('mindmapContainer');
            const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || 
                               document.mozFullScreenElement || document.msFullscreenElement;
            
            if (isFullscreen) {
                // 进入全屏：获取容器实际尺寸并设置给 ECharts 内部元素
                const containerWidth = container.offsetWidth;
                const containerHeight = container.offsetHeight;
                
                const innerDiv = container.querySelector('div');
                const canvas = container.querySelector('canvas');
                
                if (innerDiv) {
                    innerDiv.style.width = containerWidth + 'px';
                    innerDiv.style.height = containerHeight + 'px';
                }
                if (canvas) {
                    canvas.style.width = containerWidth + 'px';
                    canvas.style.height = containerHeight + 'px';
                }
            }
            
            // 多次调整图表大小以确保正确适应全屏变化
            const resizeTimes = [0, 50, 100, 200, 300];
            resizeTimes.forEach(delay => {
                setTimeout(() => {
                    if (appState.mindmapChart) {
                        appState.mindmapChart.resize();
                    }
                }, delay);
            });
        }

        // 本地上传
        function handleLocalUpload() {
            // 创建文件选择器
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.ppt,.pptx';
            
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // 显示上传进度弹窗
                const modal = document.getElementById('uploadModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // 模拟上传进度
                let progress = 0;
                const uploadInterval = setInterval(() => {
                    progress += 10;
                    document.getElementById('uploadProgress').style.width = progress + '%';
                    document.getElementById('uploadPercent').textContent = progress;
                    
                    if (progress >= 100) {
                        clearInterval(uploadInterval);
                        setTimeout(() => {
                            modal.classList.add('hidden');
                            modal.classList.remove('flex');
                            // 上传成功，创建新课件
                            createNewCourse(file);
                        }, 500);
                    }
                }, 200);
            };
            
            // 触发文件选择
            fileInput.click();
        }

        // 创建新课件
        function createNewCourse(file) {
            // 生成新课件ID
            const newId = 'course_' + String(appState.courses.length + 1).padStart(3, '0');
            
            // 获取文件类型
            let fileType = 'pdf';
            if (file.name.endsWith('.ppt') || file.name.endsWith('.pptx')) {
                fileType = 'ppt';
            }
            
            // 从文件名中提取课件名称（去掉扩展名）
            let courseName = file.name;
            // 去掉文件扩展名
            courseName = courseName.replace(/\.(pdf|ppt|pptx)$/i, '');
            
            // 创建新课件对象
            const newCourse = {
                id: newId,
                uploadTime: new Date().toISOString(),
                name: courseName,
                pages: 15,
                type: fileType,
                explanationStatus: 'generating',
                mindmapStatus: 'pending',
                videoStatus: 'pending'
            };
            
            // 添加到课件列表开头
            appState.courses.unshift(newCourse);
            
            // 💾 保存到 LocalStorage
            saveCoursesToStorage();
            
            // 使用 selectCourse 函数来选中新课件（这样会自动更新所有相关状态）
            selectCourse(newId);
            
            // 切换到课件讲解标签页
            switchTab('explanation');
            
            // 5秒后更新状态为已完成
            setTimeout(() => {
                const course = appState.courses.find(c => c.id === newId);
                if (course) {
                    course.explanationStatus = 'completed';
                    // 💾 保存状态更新
                    saveCoursesToStorage();
                    // 确保当前选中的课程是新上传的课程
                    if (appState.currentCourse === newId) {
                        // 重新渲染课件列表（更新图标）
                        renderCourseList();
                        // 重新渲染讲解页面（显示讲解内容）
                        updateCoursePage();
                    }
                    showToast('讲解生成完成！', 'success');
                }
            }, 5000);
        }

        // 开始生成讲解
        function startGeneration() {
            const modal = document.getElementById('generateModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            const stages = [
                { text: '正在解析课件内容...', duration: 2000 },
                { text: '正在分析知识点...', duration: 2000 },
                { text: '正在生成讲解文案...', duration: 2000 },
                { text: '正在进行语音合成...', duration: 2000 }
            ];
            
            let currentStage = 0;
            let currentPage = 1;
            
            function updateStage() {
                if (currentStage < stages.length) {
                    document.getElementById('generateStage').textContent = stages[currentStage].text;
                    document.getElementById('generatePage').textContent = Math.min(currentPage, 15);
                    
                    // 更新阶段图标
                    const stageNum = currentStage + 1;
                    const stageEl = document.getElementById(`stage${stageNum}`);
                    if (stageEl) {
                        stageEl.classList.remove('bg-gray-200', 'text-gray-400');
                        stageEl.classList.add('bg-primary-500', 'text-white');
                        stageEl.innerHTML = '<i data-lucide="loader" class="w-3 h-3 animate-spin"></i>';
                        lucide.createIcons();
                    }
                    
                    setTimeout(() => {
                        // 完成当前阶段
                        if (stageEl) {
                            stageEl.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i>';
                            lucide.createIcons();
                        }
                        
                        currentStage++;
                        currentPage += 3;
                        updateStage();
                    }, stages[currentStage].duration);
                } else {
                    // 完成
                    setTimeout(() => {
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                        showToast('课件讲解生成完成！', 'success');
                    }, 500);
                }
            }
            
            updateStage();
        }

        // 取消生成
        function cancelGenerate() {
            const modal = document.getElementById('generateModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            showToast('已取消生成', 'info');
        }

        // ==================== 在线课件功能 ====================
        
        // 在线课件模拟数据
        const onlineCoursesData = [
            // 数学课件
            { id: 'oc_001', name: '等腰三角形的判定', subject: '数学', grade: '八年级', version: '人教版', unit: '第十二章 全等三角形', pages: 15 },
            { id: 'oc_002', name: '勾股定理', subject: '数学', grade: '八年级', version: '人教版', unit: '第十七章 勾股定理', pages: 18 },
            { id: 'oc_003', name: '一元二次方程', subject: '数学', grade: '九年级', version: '人教版', unit: '第二十一章 一元二次方程', pages: 20 },
            { id: 'oc_004', name: '二次函数', subject: '数学', grade: '九年级', version: '人教版', unit: '第二十六章 二次函数', pages: 25 },
            { id: 'oc_005', name: '圆的认识', subject: '数学', grade: '九年级', version: '人教版', unit: '第二十四章 圆', pages: 22 },
            { id: 'oc_006', name: '平行四边形', subject: '数学', grade: '八年级', version: '北师大版', unit: '第六章 平行四边形', pages: 16 },
            { id: 'oc_007', name: '概率初步', subject: '数学', grade: '九年级', version: '北师大版', unit: '第三章 概率的进一步认识', pages: 14 },
            { id: 'oc_008', name: '有理数', subject: '数学', grade: '七年级', version: '人教版', unit: '第一章 有理数', pages: 20 },
            { id: 'oc_009', name: '整式的加减', subject: '数学', grade: '七年级', version: '人教版', unit: '第二章 整式的加减', pages: 18 },
            
            // 语文课件
            { id: 'oc_010', name: '春', subject: '语文', grade: '七年级', version: '人教版', unit: '第一单元', pages: 12 },
            { id: 'oc_011', name: '济南的冬天', subject: '语文', grade: '七年级', version: '人教版', unit: '第一单元', pages: 10 },
            { id: 'oc_012', name: '背影', subject: '语文', grade: '八年级', version: '人教版', unit: '第二单元', pages: 15 },
            { id: 'oc_013', name: '藤野先生', subject: '语文', grade: '八年级', version: '人教版', unit: '第二单元', pages: 18 },
            { id: 'oc_014', name: '岳阳楼记', subject: '语文', grade: '九年级', version: '人教版', unit: '第六单元', pages: 14 },
            { id: 'oc_015', name: '醉翁亭记', subject: '语文', grade: '九年级', version: '人教版', unit: '第六单元', pages: 16 },
            { id: 'oc_016', name: '诗经·关雎', subject: '语文', grade: '九年级', version: '人教版', unit: '第五单元', pages: 10 },
            { id: 'oc_017', name: '论语十二章', subject: '语文', grade: '七年级', version: '人教版', unit: '第三单元', pages: 12 },
            { id: 'oc_018', name: '散步', subject: '语文', grade: '七年级', version: '人教版', unit: '第一单元', pages: 8 },
            { id: 'oc_019', name: '秋天的怀念', subject: '语文', grade: '七年级', version: '人教版', unit: '第二单元', pages: 10 },
            
            // 英语课件
            { id: 'oc_020', name: '定语从句', subject: '英语', grade: '九年级', version: '人教版', unit: 'Unit 5 What are the shirts made of?', pages: 12 },
            { id: 'oc_021', name: '被动语态', subject: '英语', grade: '九年级', version: '人教版', unit: 'Unit 6 When was it invented?', pages: 14 },
            { id: 'oc_022', name: '现在完成时', subject: '英语', grade: '八年级', version: '人教版', unit: 'Unit 9 Have you ever been to a museum?', pages: 10 },
            { id: 'oc_023', name: '一般过去时', subject: '英语', grade: '七年级', version: '人教版', unit: 'Unit 11 How was your school trip?', pages: 12 },
            { id: 'oc_024', name: '情态动词', subject: '英语', grade: '八年级', version: '人教版', unit: 'Unit 2 Help to clean up the city parks', pages: 15 },
            { id: 'oc_025', name: '宾语从句', subject: '英语', grade: '九年级', version: '人教版', unit: 'Unit 3 Could you please tell me', pages: 18 },
            { id: 'oc_026', name: '现在进行时', subject: '英语', grade: '七年级', version: '人教版', unit: 'Unit 6 Watching TV', pages: 10 },
            { id: 'oc_027', name: '比较级和最高级', subject: '英语', grade: '八年级', version: '人教版', unit: 'Unit 4 The best movie theater', pages: 14 },
        ];

        // 当前选中的在线课件
        let selectedOnlineCourse = null;

        // 打开在线课件选择弹窗
        function handleOnlineCourse() {
            const modal = document.getElementById('onlineCourseModal');
            modal.classList.add('active');
            
            // 重置分页状态
            appState.onlineCourseListPage = 1;
            appState.isLoadingMoreOnline = false;
            appState.currentFilteredOnlineCourses = [];
            
            // 初始化筛选器
            initOnlineCourseFilters();
            
            // 渲染课件列表
            renderOnlineCourseList(onlineCoursesData);
            
            // 初始化滚动监听
            initOnlineCourseListScroll();
            
            // 重新初始化图标
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 50);
        }

        // 关闭在线课件选择弹窗
        function closeOnlineCourseModal() {
            const modal = document.getElementById('onlineCourseModal');
            modal.classList.remove('active');
            selectedOnlineCourse = null;
            
            // 重置筛选器
            resetOnlineCourseFilters();
        }

        // 点击背景关闭弹窗
        function closeOnlineCourseModalByBackdrop(event) {
            if (event.target.id === 'onlineCourseModal') {
                closeOnlineCourseModal();
            }
        }

        // 自定义下拉组件实例
        let subjectSelectInstance = null;
        let gradeSelectInstance = null;
        let versionSelectInstance = null;
        let unitSelectInstance = null;

        // 初始化筛选器选项
        function initOnlineCourseFilters() {
            // 只保留语文、数学、英语三个科目
            const allowedSubjects = ['语文', '数学', '英语'];
            
            // 初始化科目选择器
            subjectSelectInstance = new CustomSelect({
                container: '#subjectFilterContainer',
                placeholder: '请选择科目',
                options: allowedSubjects,
                value: '',
                clearable: true,
                onChange: (value) => {
                    // 科目改变时，清空所有下级选择器
                    gradeSelectInstance.setValue('', false);
                    versionSelectInstance.setValue('', false);
                    unitSelectInstance.setValue('', false);
                    filterOnlineCourses();
                }
            });

            // 初始化年级选择器（默认禁用）
            gradeSelectInstance = new CustomSelect({
                container: '#gradeFilterContainer',
                placeholder: '请选择年级',
                options: [],
                value: '',
                disabled: true,
                clearable: true,
                onChange: (value) => {
                    filterOnlineCourses();
                }
            });

            // 初始化版本选择器（默认禁用）
            versionSelectInstance = new CustomSelect({
                container: '#versionFilterContainer',
                placeholder: '请选择版本',
                options: [],
                value: '',
                disabled: true,
                clearable: true,
                onChange: (value) => {
                    filterOnlineCourses();
                }
            });

            // 初始化单元选择器（默认禁用）
            unitSelectInstance = new CustomSelect({
                container: '#unitFilterContainer',
                placeholder: '请选择单元',
                options: [],
                value: '',
                disabled: true,
                clearable: true,
                onChange: (value) => {
                    filterOnlineCourses();
                }
            });
        }

        // 重置筛选器
        function resetOnlineCourseFilters() {
            if (subjectSelectInstance) subjectSelectInstance.reset();
            if (gradeSelectInstance) {
                gradeSelectInstance.setOptions([]);
                gradeSelectInstance.disable();
            }
            if (versionSelectInstance) {
                versionSelectInstance.setOptions([]);
                versionSelectInstance.disable();
            }
            if (unitSelectInstance) {
                unitSelectInstance.setOptions([]);
                unitSelectInstance.disable();
            }
            document.getElementById('onlineCourseSearchInput').value = '';
        }

        // 处理在线课件搜索输入（带防抖）
        function handleOnlineCourseSearchInput() {
            // 清除之前的定时器
            if (onlineCourseSearchDebounceTimer) {
                clearTimeout(onlineCourseSearchDebounceTimer);
            }
            
            // 设置新的定时器，300ms 后执行搜索
            onlineCourseSearchDebounceTimer = setTimeout(() => {
                filterOnlineCourses(false);
            }, 300);
        }

        // 筛选课件
        function filterOnlineCourses(updateCascade = true) {
            const subjectValue = subjectSelectInstance ? subjectSelectInstance.getValue() : '';
            const gradeValue = gradeSelectInstance ? gradeSelectInstance.getValue() : '';
            const versionValue = versionSelectInstance ? versionSelectInstance.getValue() : '';
            const unitValue = unitSelectInstance ? unitSelectInstance.getValue() : '';
            const searchValue = document.getElementById('onlineCourseSearchInput').value.toLowerCase();

            // 只在选择器变化时更新级联筛选器，搜索框输入时不更新
            if (updateCascade) {
                updateCascadeFilters(subjectValue, gradeValue, versionValue, unitValue);
            }

            // 应用筛选
            let filtered = onlineCoursesData;

            if (subjectValue) {
                filtered = filtered.filter(c => c.subject === subjectValue);
            }
            if (gradeValue) {
                filtered = filtered.filter(c => c.grade === gradeValue);
            }
            if (versionValue) {
                filtered = filtered.filter(c => c.version === versionValue);
            }
            if (unitValue) {
                filtered = filtered.filter(c => c.unit === unitValue);
            }
            if (searchValue) {
                filtered = filtered.filter(c => c.name.toLowerCase().includes(searchValue));
            }

            // 重置分页并重新渲染（第二个参数为 false 表示不是追加模式）
            renderOnlineCourseList(filtered, false);
        }

        // 更新级联筛选器
        function updateCascadeFilters(subject, grade, version, unit) {
            // 根据科目更新年级
            if (subject) {
                const grades = [...new Set(onlineCoursesData.filter(c => c.subject === subject).map(c => c.grade))];
                gradeSelectInstance.setOptions(grades);
                gradeSelectInstance.enable();
                
                // 保持用户选择的年级（仅当该年级在新选项中存在）
                if (grade && grades.includes(grade)) {
                    gradeSelectInstance.setValue(grade, false);
                } else {
                    // 年级不存在或已清空，清空所有下级
                    gradeSelectInstance.setValue('', false);
                    versionSelectInstance.setValue('', false);
                    versionSelectInstance.setOptions([]);
                    versionSelectInstance.disable();
                    unitSelectInstance.setValue('', false);
                    unitSelectInstance.setOptions([]);
                    unitSelectInstance.disable();
                    return;
                }
            } else {
                // 科目为空，清空并禁用所有下级
                gradeSelectInstance.setValue('', false);
                gradeSelectInstance.setOptions([]);
                gradeSelectInstance.disable();
                versionSelectInstance.setValue('', false);
                versionSelectInstance.setOptions([]);
                versionSelectInstance.disable();
                unitSelectInstance.setValue('', false);
                unitSelectInstance.setOptions([]);
                unitSelectInstance.disable();
                return;
            }

            // 根据科目和年级更新版本
            if (grade) {
                const versions = [...new Set(onlineCoursesData
                    .filter(c => c.subject === subject && c.grade === grade)
                    .map(c => c.version))];
                versionSelectInstance.setOptions(versions);
                versionSelectInstance.enable();
                
                // 保持用户选择的版本（仅当该版本在新选项中存在）
                if (version && versions.includes(version)) {
                    versionSelectInstance.setValue(version, false);
                } else {
                    // 版本不存在或已清空，清空所有下级
                    versionSelectInstance.setValue('', false);
                    unitSelectInstance.setValue('', false);
                    unitSelectInstance.setOptions([]);
                    unitSelectInstance.disable();
                    return;
                }
            } else {
                // 年级为空，清空并禁用所有下级
                versionSelectInstance.setValue('', false);
                versionSelectInstance.setOptions([]);
                versionSelectInstance.disable();
                unitSelectInstance.setValue('', false);
                unitSelectInstance.setOptions([]);
                unitSelectInstance.disable();
                return;
            }

            // 根据科目、年级和版本更新单元
            if (version) {
                const units = [...new Set(onlineCoursesData
                    .filter(c => c.subject === subject && c.grade === grade && c.version === version)
                    .map(c => c.unit))];
                unitSelectInstance.setOptions(units);
                unitSelectInstance.enable();
                
                // 保持用户选择的单元（仅当该单元在新选项中存在）
                if (unit && units.includes(unit)) {
                    unitSelectInstance.setValue(unit, false);
                } else {
                    // 单元不存在或已清空
                    unitSelectInstance.setValue('', false);
                }
            } else {
                // 版本为空，清空并禁用单元
                unitSelectInstance.setValue('', false);
                unitSelectInstance.setOptions([]);
                unitSelectInstance.disable();
            }
        }

        // 渲染课件列表（支持懒加载）
        function renderOnlineCourseList(courses, append = false) {
            const listContainer = document.getElementById('onlineCourseList');
            
            // 保存筛选后的课件列表
            if (!append) {
                appState.currentFilteredOnlineCourses = courses;
                appState.onlineCourseListPage = 1;
            }
            
            if (courses.length === 0 && !append) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <i data-lucide="inbox" class="mx-auto"></i>
                        <p class="text-sm">暂无符合条件的课件</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            // 计算当前页的课件
            const startIndex = (appState.onlineCourseListPage - 1) * appState.onlineCourseListPageSize;
            const endIndex = startIndex + appState.onlineCourseListPageSize;
            const currentPageCourses = appState.currentFilteredOnlineCourses.slice(startIndex, endIndex);
            
            if (!append) {
                // 首次加载，清空列表
                listContainer.innerHTML = '';
            }
            
            // 渲染当前页的课件
            const coursesHTML = currentPageCourses.map(course => `
                <div class="course-item">
                    <div class="course-item-content" onclick="selectOnlineCourse('${course.id}')">
                        <div class="course-item-name">${course.name}</div>
                        <div class="course-item-meta">
                            ${course.subject} · ${course.grade} · ${course.version} · ${course.unit} · ${course.pages}页
                        </div>
                    </div>
                    <div class="course-item-actions">
                        <button class="generate-btn" onclick="event.stopPropagation(); addOnlineCourseAndGenerate('${course.id}')">
                            生成讲解
                        </button>
                    </div>
                </div>
            `).join('');
            
            listContainer.insertAdjacentHTML('beforeend', coursesHTML);
            
            // 移除旧的加载指示器（如果有）
            const oldLoader = document.getElementById('onlineCourseListLoader');
            if (oldLoader) oldLoader.remove();
            
            // 如果还有更多课件，显示加载指示器
            if (endIndex < appState.currentFilteredOnlineCourses.length) {
                const loader = document.createElement('div');
                loader.id = 'onlineCourseListLoader';
                loader.className = 'text-center py-3 text-xs text-gray-400';
                loader.innerHTML = '<i data-lucide="loader" class="w-4 h-4 inline-block animate-spin"></i> 加载中...';
                listContainer.appendChild(loader);
            }

            // 重新初始化图标
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 50);
            
            appState.isLoadingMoreOnline = false;
        }

        // 加载更多在线课件
        function loadMoreOnlineCourses() {
            if (appState.isLoadingMoreOnline) return;
            
            const totalLoaded = appState.onlineCourseListPage * appState.onlineCourseListPageSize;
            
            // 如果已经加载完所有课件
            if (totalLoaded >= appState.currentFilteredOnlineCourses.length) return;
            
            appState.isLoadingMoreOnline = true;
            appState.onlineCourseListPage++;
            
            // 模拟加载延迟，让用户看到加载动画
            setTimeout(() => {
                renderOnlineCourseList(appState.currentFilteredOnlineCourses, true);
            }, 300);
        }

        // 监听在线课件列表滚动事件
        function initOnlineCourseListScroll() {
            const listContainer = document.getElementById('onlineCourseList');
            
            // 移除旧的监听器（如果有）
            const oldListener = listContainer._scrollListener;
            if (oldListener) {
                listContainer.removeEventListener('scroll', oldListener);
            }
            
            // 创建新的监听器
            const scrollListener = function() {
                // 计算是否滚动到底部（距离底部小于50px时触发）
                const scrollTop = listContainer.scrollTop;
                const scrollHeight = listContainer.scrollHeight;
                const clientHeight = listContainer.clientHeight;
                
                if (scrollHeight - scrollTop - clientHeight < 50) {
                    loadMoreOnlineCourses();
                }
            };
            
            // 保存监听器引用，方便后续移除
            listContainer._scrollListener = scrollListener;
            
            // 添加监听器
            listContainer.addEventListener('scroll', scrollListener);
        }

        // 选择课件（在线课件选择弹窗中使用，已弃用但保留以防其他地方调用）
        function selectOnlineCourse(courseId) {
            const course = onlineCoursesData.find(c => c.id === courseId);
            if (course) {
                selectedOnlineCourse = course;
                
            }
        }

        // 为指定课件生成讲解
        function generateExplanationForCourse(courseId) {
            const course = appState.courses.find(c => c.id === courseId);
            if (!course) return;

            // 检查是否已经在生成中
            if (course.explanationStatus === 'generating') {
                showToast('该课件正在生成讲解中...', 'info');
                return;
            }

            // 检查是否已经生成完成
            if (course.explanationStatus === 'completed') {
                showToast('该课件已生成讲解，可直接查看', 'info');
                // 选中该课件并切换到讲解标签
                selectCourse(courseId);
                switchTab('explanation');
                return;
            }

            // 开始生成
            course.explanationStatus = 'generating';
            renderCourseList();

            // 显示提示
            showToast(`开始生成「${course.name}」的讲解...`, 'info');

            // 模拟生成过程
            setTimeout(() => {
                course.explanationStatus = 'completed';
                renderCourseList();
                
                // 如果当前选中的是这个课件，更新详情
                if (appState.currentCourse === courseId) {
                    updateCoursePage();
                }
                
                showToast(`「${course.name}」讲解生成完成！`, 'success');
            }, 3000);
        }

        // 添加在线课件并生成讲解
        function addOnlineCourseAndGenerate(onlineCourseId) {
            const onlineCourse = onlineCoursesData.find(c => c.id === onlineCourseId);
            if (!onlineCourse) return;

            // 检查是否已经添加过
            const existingCourse = appState.courses.find(c => c.id === onlineCourseId);
            if (existingCourse) {
                // 已添加，关闭弹窗，选中课件并生成讲解
                closeOnlineCourseModal();
                selectCourse(existingCourse.id);
                generateExplanationForCourse(existingCourse.id);
                return;
            }

            // 添加到本地课件列表
            const newCourse = {
                ...onlineCourse,
                type: 'online',
                uploadTime: new Date().toISOString(),
                explanationStatus: 'generating'  // 直接设置为生成中状态
            };
            
            appState.courses.unshift(newCourse);
            renderCourseList();

            // 关闭弹窗
            closeOnlineCourseModal();

            // 选中该课件
            selectCourse(newCourse.id);

            // 显示提示
            showToast(`开始生成「${newCourse.name}」的讲解...`, 'info');

            // 模拟生成过程（3秒后完成）
            setTimeout(() => {
                newCourse.explanationStatus = 'completed';
                renderCourseList();
                
                // 更新详情页
                if (appState.currentCourse === newCourse.id) {
                    updateCoursePage();
                }
                
                showToast(`「${newCourse.name}」讲解生成完成！`, 'success');
            }, 3000);
        }

        // 防抖定时器
        let searchDebounceTimer = null;
        let onlineCourseSearchDebounceTimer = null;

        // 处理课件搜索
        function handleCourseSearch(keyword) {
            // 更新搜索关键词
            appState.searchKeyword = keyword.trim();
            
            // 重新渲染课件列表
            renderCourseList();
        }

        // 实时搜索（带防抖）
        function handleSearchInput() {
            const input = document.getElementById('courseSearchInput');
            const clearBtn = document.getElementById('clearSearchBtn');
            
            // 更新清空按钮显示状态
            if (input.value.trim()) {
                clearBtn.classList.add('has-content');
            } else {
                clearBtn.classList.remove('has-content');
            }
            
            // 清除之前的定时器
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }
            
            // 设置新的定时器，300ms 后执行搜索
            searchDebounceTimer = setTimeout(() => {
                handleCourseSearch(input.value);
            }, 300);
        }

        // 清空搜索
        function clearSearch() {
            const input = document.getElementById('courseSearchInput');
            input.value = '';
            
            // 清除防抖定时器
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }
            
            // 更新按钮状态
            const clearBtn = document.getElementById('clearSearchBtn');
            clearBtn.classList.remove('has-content');
            
            // 立即执行搜索（显示所有课件）
            handleCourseSearch('');
        }

        // 重新生成讲解
        function regenerateExplanation() {
            // 更新状态为生成中
            const course = getCurrentCourse();
            if (course) {
                course.explanationStatus = 'generating';
                // 💾 保存到 LocalStorage
                saveCoursesToStorage();
            }
            
            // 直接在内容区呈现生成中状态
            if (appState.currentTab !== 'explanation') {
                switchTab('explanation');
            } else {
                updateCoursePage();
            }
            
            // 5秒后以70%成功、30%失败结束
            setTimeout(() => {
                const updatedCourse = getCurrentCourse();
                if (!updatedCourse) return;
                const isSuccess = Math.random() < 0.7;
                updatedCourse.explanationStatus = isSuccess ? 'completed' : 'failed';
                saveCoursesToStorage();
                // 刷新显示
                updateCoursePage();
                showToast(isSuccess ? '讲解生成成功！' : '讲解生成失败', isSuccess ? 'success' : 'error');
            }, 5000);
        }

        // 生成思维导图
        function generateMindmap() {
            // 更新状态为生成中
            const course = getCurrentCourse();
            if (course) {
                course.mindmapStatus = 'generating';
                // 💾 保存到 LocalStorage
                saveCoursesToStorage();
            }
            
            // 直接在内容区呈现生成中状态
            if (appState.currentTab !== 'mindmap') {
                switchTab('mindmap');
            } else {
                switchTab('mindmap');
            }
            
            // 5秒后以70%成功、30%失败结束
            setTimeout(() => {
                const updatedCourse = getCurrentCourse();
                if (!updatedCourse) return;
                const isSuccess = Math.random() < 0.7;
                updatedCourse.mindmapStatus = isSuccess ? 'completed' : 'failed';
                saveCoursesToStorage();
                // 刷新显示
                switchTab('mindmap');
                showToast(isSuccess ? '思维导图生成成功！' : '思维导图生成失败', isSuccess ? 'success' : 'error');
            }, 5000);
        }

        // 生成视频
        function generateVideo() {
            // 更新状态为生成中
            const course = getCurrentCourse();
            if (course) {
                course.videoStatus = 'generating';
                // 💾 保存到 LocalStorage
                saveCoursesToStorage();
            }
            
            // 直接在内容区呈现生成中状态
            if (appState.currentTab !== 'video') {
                switchTab('video');
            } else {
                switchTab('video');
            }
            
            // 5秒后以70%成功、30%失败结束
            setTimeout(() => {
                const updatedCourse = getCurrentCourse();
                if (!updatedCourse) return;
                const isSuccess = Math.random() < 0.7;
                updatedCourse.videoStatus = isSuccess ? 'completed' : 'failed';
                saveCoursesToStorage();
                // 刷新显示
                switchTab('video');
                showToast(isSuccess ? '视频概览生成成功！' : '视频概览生成失败', isSuccess ? 'success' : 'error');
            }, 5000);
        }

        // Toast提示 - 支持类型区分
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');
            
            messageEl.textContent = message;
            
            // 根据类型设置不同的颜色和图标
            let bgColor, iconName;
            if (type === 'success') {
                bgColor = 'bg-green-500';
                iconName = 'check-circle';
            } else if (type === 'error') {
                bgColor = 'bg-amber-500'; // 琥珀色更友好
                iconName = 'alert-circle';
            } else if (type === 'info') {
                bgColor = 'bg-blue-500';
                iconName = 'info';
            } else {
                bgColor = 'bg-gray-900';
                iconName = 'check-circle';
            }
            
            // 重置类名并显示
            toast.className = `fixed top-20 left-1/2 -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-xl shadow-2xl z-[100] transition-all duration-300 flex items-center gap-3 opacity-100 transform translate-y-0`;
            toast.classList.remove('pointer-events-none');
            
            // 更新图标
            icon.setAttribute('data-lucide', iconName);
            lucide.createIcons();
            
            // 3秒后自动隐藏
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', '-translate-y-2');
                
                // 完全隐藏后添加 pointer-events-none
                setTimeout(() => {
                    toast.classList.add('pointer-events-none');
                }, 300);
            }, 3000);
        }

        // 加载旁白数据
        async function loadNarrationData() {
            try {
                const response = await fetch('data/narration.json');
                appState.narrationData = await response.json();
                console.log('旁白数据加载成功', appState.narrationData);
            } catch (error) {
                console.error('加载旁白数据失败:', error);
                showToast('旁白数据加载失败', 'error');
            }
        }

        // 保存课程数据到 LocalStorage
        function saveCoursesToStorage() {
            try {
                const data = {
                    courses: appState.courses,
                    lastUpdate: new Date().toISOString()
                };
                localStorage.setItem('explainai_courses', JSON.stringify(data));
                console.log('课程数据已保存到 LocalStorage');
            } catch (e) {
                console.error('保存课程数据失败:', e);
                showToast('保存数据失败', 'error');
            }
        }

        // 从 LocalStorage 加载课程数据
        function loadCoursesFromStorage() {
            try {
                const stored = localStorage.getItem('explainai_courses');
                if (stored) {
                    const data = JSON.parse(stored);
                    return Array.isArray(data.courses) ? data.courses : [];
                }
            } catch (e) {
                console.error('从 LocalStorage 加载数据失败:', e);
            }
            return null;
        }

        // 加载课程数据（优先从 LocalStorage，否则从 JSON 文件）
        async function loadCourses() {
            try {
                // 先尝试从 LocalStorage 加载
                const storedCourses = loadCoursesFromStorage();
                
                if (storedCourses && storedCourses.length > 0) {
                    // 如果 LocalStorage 有数据，优先使用
                    appState.courses = storedCourses;
                    console.log('从 LocalStorage 加载了', storedCourses.length, '个课程');
                } else {
                    // 否则从 JSON 文件加载初始数据
                    const res = await fetch('data/courses.json');
                    const data = await res.json();
                    appState.courses = Array.isArray(data.courses) ? data.courses : [];
                    console.log('从 courses.json 加载了', appState.courses.length, '个课程');
                }
                
                // 默认选中最新上传的课程
                appState.courses.sort((a, b) => new Date(b.uploadTime) - new Date(a.uploadTime));
                if (appState.courses.length > 0) {
                    appState.currentCourse = appState.courses[0].id;
                    appState.totalPages = appState.courses[0].pages;
                    document.getElementById('courseTitle').textContent = appState.courses[0].name;
                }
                renderCourseList();
                updateCoursePage();
                
                // 初始化清空按钮状态
                const input = document.getElementById('courseSearchInput');
                const clearBtn = document.getElementById('clearSearchBtn');
                if (input && clearBtn) {
                    if (input.value.trim()) {
                        clearBtn.classList.add('has-content');
                    } else {
                        clearBtn.classList.remove('has-content');
                    }
                }
            } catch (e) {
                console.error('加载课程数据失败:', e);
                showToast('课程数据加载失败', 'error');
            }
        }

        // 获取当前选中课程
        function getCurrentCourse() {
            if (!appState.currentCourse) return null;
            return appState.courses.find(c => c.id === appState.currentCourse) || null;
        }

        // 重置存储数据
        function resetStorage() {
            if (confirm('确定要清空所有本地数据并重新加载原始课程吗？\n\n此操作将删除所有新增的课件和生成的内容。')) {
                try {
                    // 清空 LocalStorage
                    localStorage.removeItem('explainai_courses');
                    showToast('数据已重置', 'success');
                    // 重新加载页面
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } catch (e) {
                    console.error('重置数据失败:', e);
                    showToast('重置失败', 'error');
                }
            }
        }

        // 页面加载完成

        // 加载更多课件
        function loadMoreCourses() {
            if (appState.isLoadingMore) return;
            
            // 过滤后的课件总数
            const filtered = appState.courses
                .filter(c => !appState.searchKeyword || c.name.includes(appState.searchKeyword));
            
            const totalLoaded = appState.courseListPage * appState.courseListPageSize;
            
            // 如果已经加载完所有课件
            if (totalLoaded >= filtered.length) return;
            
            appState.isLoadingMore = true;
            appState.courseListPage++;
            
            // 模拟加载延迟，让用户看到加载动画
            setTimeout(() => {
                renderCourseList(true);
            }, 300);
        }

        // 监听课件列表滚动事件
        function initCourseListScroll() {
            const courseList = document.getElementById('courseList');
            
            courseList.addEventListener('scroll', function() {
                // 计算是否滚动到底部（距离底部小于50px时触发）
                const scrollTop = courseList.scrollTop;
                const scrollHeight = courseList.scrollHeight;
                const clientHeight = courseList.clientHeight;
                
                if (scrollHeight - scrollTop - clientHeight < 50) {
                    loadMoreCourses();
                }
            });
        }

        // 当列表不可滚动但仍有更多数据时，自动加载直至可滚动或加载完
        function autoFillCourseListIfNeeded() {
            const courseList = document.getElementById('courseList');
            const loader = document.getElementById('courseListLoader');
            if (!courseList || !loader) return;
            if (appState.isLoadingMore) return;

            const canScroll = (courseList.scrollHeight - courseList.clientHeight) > 5;
            if (!canScroll) {
                if (typeof appState._autoFillCourseAttempts !== 'number') {
                    appState._autoFillCourseAttempts = 0;
                }
                if (appState._autoFillCourseAttempts >= 8) return;
                appState._autoFillCourseAttempts++;
                loadMoreCourses();
                setTimeout(autoFillCourseListIfNeeded, 450);
            } else {
                appState._autoFillCourseAttempts = 0;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 加载数据
            loadCourses();
            // 加载旁白数据
            loadNarrationData();
            // 初始化课件列表滚动监听
            initCourseListScroll();
            
            lucide.createIcons();
        });

        // 监听思维导图全屏状态变化
        document.addEventListener('fullscreenchange', () => {
            const mindmapFullscreenIcon = document.getElementById('mindmapFullscreenIcon');
            if (mindmapFullscreenIcon) {
                if (document.fullscreenElement) {
                    mindmapFullscreenIcon.setAttribute('data-lucide', 'minimize');
                } else {
                    mindmapFullscreenIcon.setAttribute('data-lucide', 'maximize');
                }
                lucide.createIcons();
                
                // 调整图表大小
                if (appState.mindmapChart) {
                    appState.mindmapChart.resize();
                }
            }
        });

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            // 只在课件讲解Tab且没有其他模态框时响应
            if (appState.currentTab === 'explanation') {
                // 左箭头：上一页
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    previousPage();
                }
                // 右箭头：下一页
                if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    nextPage();
                }
                // 空格键：播放/暂停
                if (e.key === ' ') {
                    e.preventDefault();
                    togglePlay();
                }
                // F键：全屏
                if (e.key === 'f' || e.key === 'F') {
                    e.preventDefault();
                    toggleFullscreen();
                }
                // M键：音量控制
                if (e.key === 'm' || e.key === 'M') {
                    e.preventDefault();
                    toggleVolumeSlider();
                }
            }
        });

        // 窗口大小改变时重新渲染思维导图
        window.addEventListener('resize', () => {
            if (appState.mindmapChart) {
                appState.mindmapChart.resize();
            }
        });

        // 返回功能
        function goBack() {
            window.history.back();
        }
    </script>
    </div>

    <!-- Confirm 确认对话框 -->
    <div id="confirmDialog" class="fixed inset-0 bg-black/50 z-[300] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all scale-95 opacity-0" id="confirmDialogInner">
            <div class="p-6">
                <div class="flex items-start gap-4">
                    <div class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="alert-circle" class="w-6 h-6 text-amber-600"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2" id="confirmDialogTitle">确认操作</h3>
                        <p class="text-gray-600 text-sm leading-relaxed" id="confirmDialogMessage">确定要执行此操作吗？</p>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-100 p-4 flex gap-3 justify-end">
                <button id="confirmDialogCancel" class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all">
                    取消
                </button>
                <button id="confirmDialogConfirm" class="px-5 py-2.5 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-all">
                    确定
                </button>
            </div>
        </div>
    </div>
</body>
</html>

